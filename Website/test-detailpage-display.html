<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DetailPage数据库字段显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .result {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        .detail-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        .facts-grid, .parties-grid, .disbursement-grid, .collateral-grid, .default-grid, .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .fact-item, .party-item, .disbursement-item, .collateral-item, .default-item, .document-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .fact-label, .party-label, .disbursement-label, .collateral-label, .default-label, .document-label {
            font-weight: bold;
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .fact-value, .party-value, .disbursement-value, .collateral-value, .default-value, .document-value {
            color: #333;
            font-size: 16px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .doc-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        .doc-btn:hover {
            background: #0056b3;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .field-mapping {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .field-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        .field-db {
            font-family: monospace;
            color: #666;
        }
        .field-display {
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>DetailPage数据库字段显示测试</h1>
    <p>此页面用于测试DetailPage页面的数据库字段映射和显示功能。</p>

    <div class="test-container">
        <div class="test-section">
            <div class="test-title">1. 数据获取和字段映射测试</div>
            <div id="dataTestResult">
                <div class="loading">正在测试数据获取...</div>
            </div>
            <button onclick="testDataMapping()">测试数据映射</button>
        </div>

        <div class="test-section">
            <div class="test-title">2. DetailPage显示效果测试</div>
            <div id="detailPageDisplay">
                <div class="loading">先进行数据映射测试</div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">3. 字段映射对照表</div>
            <div id="fieldMappingTable">
                <div class="loading">等待数据映射测试完成</div>
            </div>
        </div>
    </div>

    <script>
        let productData = null;

        // 测试数据映射
        async function testDataMapping() {
            const resultDiv = document.getElementById('dataTestResult');
            resultDiv.innerHTML = '<div class="loading">正在获取和映射数据...</div>';
            
            try {
                // 获取RWA001产品数据
                const response = await fetch('http://localhost:3000/api/product_details/RWA001');
                const data = await response.json();
                
                if (data.status === 0) {
                    const rawData = data.data;
                    
                    // 模拟DetailPage中的字段映射
                    productData = {
                        ...rawData,
                        totalOffering: rawData.total_token,
                        subscribed: rawData.current_subscribed_token,
                        targetYield: rawData.target_yield,
                        ltv: rawData.LTV,
                        annualInterestRate: rawData.annual_interest_rate,
                        loanAmount: rawData.loan_amount,
                        valuation: rawData.valuation,
                        image: getProductImage(rawData.code)
                    };
                    
                    resultDiv.innerHTML = `
                        <div class="result">
                            ✅ 数据映射成功<br>
                            产品代码: ${productData.code}<br>
                            产品名称: ${productData.name}<br>
                            映射时间: ${new Date().toLocaleString()}
                        </div>
                    `;
                    
                    // 显示DetailPage效果
                    displayDetailPage();
                    
                    // 显示字段映射表
                    displayFieldMappingTable();
                    
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ❌ 获取数据失败<br>
                            状态码: ${data.status}<br>
                            错误消息: ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ❌ 网络错误<br>
                        错误: ${error.message}
                    </div>
                `;
            }
        }

        // 显示DetailPage效果
        function displayDetailPage() {
            const displayDiv = document.getElementById('detailPageDisplay');
            
            if (!productData) {
                displayDiv.innerHTML = '<div class="loading">没有产品数据</div>';
                return;
            }
            
            const html = `
                <div class="detail-container">
                    <h1>${productData.name}</h1>
                    <p style="color: #666; margin-bottom: 30px;">${productData.subtitle}</p>
                    
                    <!-- Key Facts -->
                    <div class="section">
                        <h2>Key Facts</h2>
                        <div class="facts-grid">
                            <div class="fact-item">
                                <div class="fact-label">Project Code</div>
                                <div class="fact-value">${productData.code}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Project Name</div>
                                <div class="fact-value">${productData.name}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Project Type</div>
                                <div class="fact-value">${productData.type}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Region</div>
                                <div class="fact-value">${productData.region}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Risk Level</div>
                                <div class="fact-value">${productData.risk}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Status</div>
                                <div class="fact-value">${productData.status}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Target Yield</div>
                                <div class="fact-value">${productData.targetYield}%</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Total Offering</div>
                                <div class="fact-value">A$${formatNumber(productData.totalOffering)}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Subscribed</div>
                                <div class="fact-value">A$${formatNumber(productData.subscribed)}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Loan Amount</div>
                                <div class="fact-value">A$${formatNumber(productData.loanAmount)}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Annual Interest Rate</div>
                                <div class="fact-value">${productData.annualInterestRate}%</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Loan Term</div>
                                <div class="fact-value">${productData.loanTerm} months</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">LTV (Loan-to-Value)</div>
                                <div class="fact-value">${productData.ltv}%</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Drawdown Date</div>
                                <div class="fact-value">${formatDate(productData.drawdownDate)}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Early Repayment</div>
                                <div class="fact-value">${productData.earlyRepayment}</div>
                            </div>
                            <div class="fact-item">
                                <div class="fact-label">Repayment Arrangement</div>
                                <div class="fact-value">${productData.repaymentArrangement}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parties -->
                    <div class="section">
                        <h2>Parties</h2>
                        <div class="parties-grid">
                            <div class="party-item">
                                <div class="party-label">Issuer</div>
                                <div class="party-value">${productData.issuer}</div>
                            </div>
                            <div class="party-item">
                                <div class="party-label">PW Shareholders</div>
                                <div class="party-value">${productData.pw_shareholders}</div>
                            </div>
                            <div class="party-item">
                                <div class="party-label">Lender</div>
                                <div class="party-value">${productData.lender}</div>
                            </div>
                            <div class="party-item">
                                <div class="party-label">Borrower</div>
                                <div class="party-value">${productData.borrower}</div>
                            </div>
                            <div class="party-item">
                                <div class="party-label">Guarantor</div>
                                <div class="party-value">${productData.guarantor}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Disbursement & Interest -->
                    <div class="section">
                        <h2>Disbursement & Interest</h2>
                        <div class="disbursement-grid">
                            <div class="disbursement-item">
                                <div class="disbursement-label">Disbursement Method</div>
                                <div class="disbursement-value">${productData.disbursement_method}</div>
                            </div>
                            <div class="disbursement-item">
                                <div class="disbursement-label">Interest Rate</div>
                                <div class="disbursement-value">${productData.interest}</div>
                            </div>
                            <div class="disbursement-item">
                                <div class="disbursement-label">Prepayment Information</div>
                                <div class="disbursement-value">${productData.early_repayment_details}</div>
                            </div>
                            <div class="disbursement-item">
                                <div class="disbursement-label">Maturity Date</div>
                                <div class="disbursement-value">${formatDate(productData.maturity_date)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collateral -->
                    <div class="section">
                        <h2>Collateral</h2>
                        <div class="collateral-grid">
                            <div class="collateral-item">
                                <div class="collateral-label">Property Address</div>
                                <div class="collateral-value">${productData.property_address}</div>
                            </div>
                            <div class="collateral-item">
                                <div class="collateral-label">Valuation</div>
                                <div class="collateral-value">A$${formatNumber(productData.valuation)}</div>
                            </div>
                            <div class="collateral-item">
                                <div class="collateral-label">Security Ranking</div>
                                <div class="collateral-value">${productData.security_rank}</div>
                            </div>
                            <div class="collateral-item">
                                <div class="collateral-label">LVR (Loan-to-Value Ratio)</div>
                                <div class="collateral-value">${productData.lvr}%</div>
                            </div>
                            <div class="collateral-item full-width">
                                <div class="collateral-label">Project Summary</div>
                                <div class="collateral-value">${productData.summary}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Default & Remedies -->
                    <div class="section">
                        <h2>Default & Remedies</h2>
                        <div class="default-grid">
                            <div class="default-item">
                                <div class="default-label">Default Interest Rate</div>
                                <div class="default-value">${productData.default_interest_rate}</div>
                            </div>
                            <div class="default-item full-width">
                                <div class="default-label">Default Trigger Conditions</div>
                                <div class="default-value">${productData.default_triggers}</div>
                            </div>
                            <div class="default-item full-width">
                                <div class="default-label">Disposal Process</div>
                                <div class="default-value">${productData.default_process}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- On-Chain & Documents -->
                    <div class="section">
                        <h2>On-Chain & Documents</h2>
                        <div class="documents-grid">
                            <div class="document-item">
                                <div class="document-label">Issuer Token</div>
                                <div class="document-value">${productData.issuer_token}</div>
                                <button class="doc-btn">View</button>
                            </div>
                            <div class="document-item">
                                <div class="document-label">Loan Token</div>
                                <div class="document-value">${productData.loan_token}</div>
                                <button class="doc-btn">View</button>
                            </div>
                            <div class="document-item">
                                <div class="document-label">Valuation Report</div>
                                <div class="document-value">${productData.valuation_report}</div>
                                <button class="doc-btn">Download</button>
                            </div>
                            <div class="document-item">
                                <div class="document-label">Mortgage Deed</div>
                                <div class="document-value">${productData.mortgage_deed}</div>
                                <button class="doc-btn">Download</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            displayDiv.innerHTML = html;
        }

        // 显示字段映射表
        function displayFieldMappingTable() {
            const tableDiv = document.getElementById('fieldMappingTable');
            
            const fieldMappings = [
                { db: 'code', display: 'Project Code' },
                { db: 'name', display: 'Project Name' },
                { db: 'subtitle', display: 'Project Subtitle' },
                { db: 'type', display: 'Project Type' },
                { db: 'region', display: 'Region' },
                { db: 'risk', display: 'Risk Level' },
                { db: 'target_yield', display: 'Target Yield' },
                { db: 'status', display: 'Status' },
                { db: 'total_token', display: 'Total Offering' },
                { db: 'current_subscribed_token', display: 'Subscribed' },
                { db: 'loan_amount', display: 'Loan Amount' },
                { db: 'annual_interest_rate', display: 'Annual Interest Rate' },
                { db: 'loan_term', display: 'Loan Term' },
                { db: 'LTV', display: 'LTV' },
                { db: 'drawdown_date', display: 'Drawdown Date' },
                { db: 'early_repayment', display: 'Early Repayment' },
                { db: 'repayment_arrangement', display: 'Repayment Arrangement' },
                { db: 'issuer', display: 'Issuer' },
                { db: 'pw_shareholders', display: 'PW Shareholders' },
                { db: 'lender', display: 'Lender' },
                { db: 'borrower', display: 'Borrower' },
                { db: 'guarantor', display: 'Guarantor' },
                { db: 'disbursement_method', display: 'Disbursement Method' },
                { db: 'interest', display: 'Interest Rate' },
                { db: 'early_repayment_details', display: 'Early Repayment Details' },
                { db: 'maturity_date', display: 'Maturity Date' },
                { db: 'property_address', display: 'Property Address' },
                { db: 'valuation', display: 'Valuation' },
                { db: 'security_rank', display: 'Security Ranking' },
                { db: 'lvr', display: 'LVR' },
                { db: 'default_interest_rate', display: 'Default Interest Rate' },
                { db: 'default_triggers', display: 'Default Triggers' },
                { db: 'default_process', display: 'Default Process' },
                { db: 'issuer_token', display: 'Issuer Token' },
                { db: 'loan_token', display: 'Loan Token' },
                { db: 'valuation_report', display: 'Valuation Report' },
                { db: 'mortgage_deed', display: 'Mortgage Deed' },
                { db: 'summary', display: 'Project Summary' }
            ];
            
            let html = '<div class="field-mapping"><h3>数据库字段映射对照表</h3>';
            
            fieldMappings.forEach(mapping => {
                html += `
                    <div class="field-item">
                        <span class="field-db">${mapping.db}</span>
                        <span>→</span>
                        <span class="field-display">${mapping.display}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            tableDiv.innerHTML = html;
        }

        // 工具函数
        function getProductImage(code) {
            const imageMap = {
                'RWA001': '/pics/TYMU.png',
                'RWA002': '/pics/SQNB.png',
                'RWA003': '/pics/LZYT.png',
                'YYD': '/pics/YYD.png',
                'COMP': '/pics/TYMU.png'
            }
            return imageMap[code] || '/pics/TYMU.png'
        }

        function formatNumber(value) {
            if (!value) return '0'
            const num = parseFloat(value)
            if (isNaN(num)) return value
            return num.toLocaleString()
        }

        function formatDate(dateString) {
            if (!dateString) return '-'
            try {
                const date = new Date(dateString)
                return date.toLocaleDateString('en-AU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })
            } catch (error) {
                return dateString
            }
        }

        // 页面加载时自动测试
        window.onload = function() {
            testDataMapping();
        };
    </script>
</body>
</html>
