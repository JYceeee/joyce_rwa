<template>
  <div class="trade-page">
    <!-- ‰ΩôÈ¢ù‰∏çË∂≥ÂºπÁ™ó -->
    <div v-if="showInsufficientBalanceModal" class="modal-overlay" @click="closeInsufficientBalanceModal">
      <div class="modal-content error-modal" @click.stop>
        <div class="modal-header">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h2 class="modal-title">Insufficient Balance</h2>
        </div>
        <div class="modal-body">
          <div class="error-message">
            <p>Your token balance is insufficient to complete this transaction of  {{ projectCode }} .</p>
            <p><strong>Current Balance:</strong> {{ userTokenBalance }} {{ projectCode }} tokens</p>
            <p><strong>Required Amount:</strong> {{ tradeAmount }} {{ projectCode }} tokens</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn primary" @click="closeInsufficientBalanceModal">Á°ÆÂÆö</button>
        </div>
      </div>
    </div>

    <!-- Âä†ËΩΩ‰∏≠ÂºπÁ™ó -->
    <div v-if="showLoadingModal" class="modal-overlay">
      <div class="modal-content loading-modal" @click.stop>
        <div class="modal-header">
          <div class="loading-icon">
            <div class="spinner"></div>
          </div>
          <h2 class="modal-title">Processing...</h2>
        </div>
        <div class="modal-body">
          <div class="loading-message">
            <p>We are processing your transaction request, please wait...</p>
            <p class="loading-status">{{ loadingStatus }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ‰∫§ÊòìÊàêÂäüÂºπÁ™ó -->
    <div v-if="showSuccessModal" class="modal-overlay" @click="closeSuccessModal">
      <div class="modal-content success-modal" @click.stop>
        <div class="modal-header">
          <!-- <div class="success-icon">‚úÖ</div> -->
          <h2 class="modal-title">Transaction Successful!</h2>
        </div>
        <div class="modal-body">
          <div class="success-details">
            <div class="detail-item">
              <span class="detail-label">Trade Type:</span>
              <span class="detail-value">{{ successData.tradeType === 'buy' ? 'Buy' : 'Sell' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Trade Amount:</span>
              <span class="detail-value">{{ successData.amount }} Tokens</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Trade Price:</span>
              <span class="detail-value">A${{ successData.price }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Trade Total:</span>
              <span class="detail-value">A${{ successData.total }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Trade Hash:</span>
              <span class="detail-value hash-value" @click="copyHash">{{ formatHash(successData.transactionHash) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Block Number:</span>
              <span class="detail-value">{{ successData.blockNumber }}</span>
            </div>
          </div>
          <div class="success-message">
            <p>üéâ Congratulations! Your transaction has been successfully completed and recorded on the blockchain.</p>
            <p>You can view the transaction record in the "Recent Trades" on the right.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" @click="closeSuccessModal">Close</button>
          <button class="btn primary" @click="viewPortfolio">View Portfolio</button>
        </div>
      </div>
    </div>

    <!-- È°∂ÈÉ®Èù¢ÂåÖÂ±ëÂØºËà™ -->
    <header class="topbar container">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <button class="crumb-back" @click="$router.back()" aria-label="Back">
          <svg viewBox="0 0 24 24" class="i">
            <path d="M10 19a1 1 0 0 1-.7-.3l-7-7a1 1 0 0 1 0-1.4l7-7a1 1 0 1 1 1.4 1.4L4.41 11H21a1 1 0 1 1 0 2H4.41l6.3 6.3A1 1 0 0 1 10 19z"/>
          </svg>
        </button>
        <span class="sep">/</span>
        <span class="crumb">Projects</span>
        <span class="sep">/</span>
        <span class="crumb-current">Trade {{ projectCode }}</span>
      </nav>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="container main-content">
      <!-- È°πÁõÆ‰ø°ÊÅØÂç°Áâá -->
      <div class="project-info-card">
        <div class="project-header">
          <img :src="projectData.image" :alt="projectCode" class="project-image" />
          <div class="project-details">
            <h1 class="project-title">{{ projectData.code }} - {{ projectData.name }}</h1>
            <p class="project-subtitle">{{ projectData.subtitle }}</p>
            <div class="project-meta">
              <span class="meta-item">Type: {{ projectData.type }}</span>
              <span class="meta-item">Region: {{ projectData.region }}</span>
              <span class="meta-item">Risk: {{ projectData.risk }}</span>
            </div>
          </div>
        </div>
        
        <!-- È°πÁõÆÊåáÊ†á -->
        <div class="project-metrics">
          <!-- <div class="metric-item">
            <span class="metric-label">Current Price</span>
            <span class="metric-value">{{ projectData.metrics.currentElaraPrice }}</span>
          </div> -->
          <div class="metric-item">
            <span class="metric-label">Property Value</span>
            <span class="metric-value">{{ projectData.metrics.collateralPropertyValue }}</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Loan Amount</span>
            <span class="metric-value">{{ projectData.loanAmount || 'TBA' }}</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Target Yield</span>
            <span class="metric-value">{{ projectData.metrics.targetLoanYield }}</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">LTV</span>
            <span class="metric-value">{{ projectData.ltv || 'TBA' }}</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Loan Term</span>
            <span class="metric-value">{{ projectData.loanTerm || 'TBA' }}</span>
          </div>
        </div>
      </div>

      <!-- ‰∫§ÊòìË°®Âçï -->
      <div class="trade-form-card">
        <h2 class="form-title">Trade {{ projectCode }}</h2>
        


        <!-- ‰∫§ÊòìÊï∞Èáè -->
        <div class="form-section">
          <h3 class="section-title">Amount</h3>
          <div class="amount-input-group">
            <input 
              type="number" 
              v-model="tradeAmount" 
              class="amount-input"
              placeholder="Enter amount"
              min="1"
              step="1"
              @input="clearError"
            />
            <span class="amount-unit">tokens</span>
          </div>
          <div class="amount-info">
          </div>
        </div>

        <!-- ‰∫§ÊòìÁ±ªÂûãÈÄâÊã© -->
        <div class="form-section">
          <!-- <h3 class="section-title">Trade Type</h3> -->
          <div class="trade-type-buttons">
            <button 
              v-if="showBuyButton"
              class="trade-type-btn" 
              :class="{ active: tradeType === 'buy' }"
              @click="selectTradeType('buy')"
              :disabled="loading"
            >
              <span class="btn-text">Buy</span>
            </button>

            <button 
              v-if="showSellButton"
              class="trade-type-btn" 
              :class="{ active: tradeType === 'sell' }"
              @click="selectTradeType('sell')"
              :disabled="loading"
            >
              <span class="btn-text">Sell Interest</span>
            </button>
          </div>
        </div>

        <!-- Êèê‰∫§ÊåâÈíÆ -->
        <!-- <div class="form-actions">
          <button class="btn secondary" @click="cancelTrade" :disabled="loading">Cancel</button>
          <button class="btn primary" @click="submitTrade" :disabled="!canSubmit">
            <span v-if="loading">Processing...</span>
            <span v-else>{{ tradeType === 'buy' ? 'Buy Tokens' : 'Sell Tokens' }}</span>
          </button>
        </div> -->
          
        <!-- ÈîôËØØ‰ø°ÊÅØÊòæÁ§∫ -->
        <div v-if="formattedError" class="error-message">
          <div class="error-icon">‚ö†Ô∏è</div>
          <div class="error-text">{{ formattedError }}</div>
        </div>
        </div>

      <!-- ‰∫§ÊòìÂéÜÂè≤ -->
      <div class="trade-history-card">
        <div class="card-header">
          <h2 class="card-title">Recent Trades</h2>
        </div>
        <div v-if="loading" class="loading-message">Loading trades...</div>
        <div v-else-if="projectTrades.length === 0" class="no-trades">No trades found for this project</div>
        <div v-else class="trade-list">
          <div v-for="trade in projectTrades" :key="trade.id" class="trade-item">
            <div class="trade-header">
              <span class="trade-type" :class="trade.type">{{ getTradeTypeDisplay(trade.type) }}</span>
              <span class="trade-time">{{ formatTime(trade.timestamp) }}</span>
          </div>
            <div class="trade-info">
              <div class="trade-project-section">
                <span class="label">Project:</span>
                <span class="value">{{ trade.project_code }} - {{ trade.project_name }}</span>
          </div>
              <div class="trade-amount-section">
                <span class="label">Token Amount:</span>
                <span class="value"> {{ trade.amount }} tokens</span>
              </div>
              <!-- EtherscanËØ¶ÊÉÖ -->
              <div v-if="trade.etherscan" class="trade-etherscan-section">
                <div class="etherscan-info">
                  <span class="label">Transaction Hash:</span>
                  <span class="value hash-value" @click="copyHash(trade.etherscan.hash)">{{ formatHash(trade.etherscan.hash) }}</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">Status:</span>
                  <span class="value" :class="{ 'status-success': trade.etherscan.status === '0x1', 'status-failed': trade.etherscan.status === '0x0' }">
                    {{ trade.etherscan.status === '0x1' ? 'Success' : trade.etherscan.status === '0x0' ? 'Failed' : 'Pending' }}
                  </span>
                </div>
                <div class="etherscan-info">
                  <span class="label">Block:</span>
                  <span class="value">{{ trade.etherscan.blockNumber ? parseInt(trade.etherscan.blockNumber, 16).toLocaleString() : 'N/A' }}</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">Timestamp:</span>
                  <span class="value">{{ formatEtherscanTime(trade.etherscan.timestamp) }}</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">From:</span>
                  <span class="value">{{ formatAddress(trade.etherscan.from) }}</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">To:</span>
                  <span class="value">{{ formatAddress(trade.etherscan.to) }}</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">Value:</span>
                  <span class="value">{{ formatEtherValue(trade.etherscan.value) }} ETH</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">Transaction Fee:</span>
                  <span class="value">{{ trade.etherscan.transactionFee ? trade.etherscan.transactionFee.toFixed(6) : 'N/A' }} ETH</span>
                </div>
                <div class="etherscan-info">
                  <span class="label">Gas Price:</span>
                  <span class="value">{{ trade.etherscan.gasPrice ? parseInt(trade.etherscan.gasPrice, 16).toLocaleString() : 'N/A' }} Gwei</span>
                </div>
              </div>
            </div>
            <!-- EtherscanÈìæÊé• -->
            <div class="trade-footer" v-if="trade.etherscan && trade.etherscan.hash">
              <a :href="`https://sepolia.etherscan.io/tx/${trade.etherscan.hash}`" 
                 target="_blank" 
                 class="tx-link">
                üîó View on Sepolia Etherscan
              </a>
            </div>
          </div>
          </div>
          </div>
        </div>


  </div>
</template>

<script>
import { productAPI } from '@/service/api'
import { contractService } from '@/service/contractService.js'
import { getKycStatus, isKycVerified, getKycLevel, setKycLevel, KYC_STATUS, KYC_LEVELS } from '@/service/kycService.js'
import { useAuth } from '@/composables/useAuth.js'
import { useWallet } from '@/composables/useWallet.js'
import { isLoggedIn } from '@/utils/auth.js'

export default {
  name: 'TradeProjectView',
  props: {
    code: {
      type: String,
      required: false,
      default: null
    }
  },
  data() {
    return {
      tradeType: 'buy',
      tradeAmount: '',
      walletActivity: [],
      loading: false,
      error: null,
      errorType: null, // ÈîôËØØÁ±ªÂûã
      isInterestTrade: false, // ÊòØÂê¶‰∏∫Âà©ÊÅØ‰∫§Êòì
      showSuccessModal: false,
      showInsufficientBalanceModal: false,
      showLoadingModal: false,
      loadingStatus: '',
      userTokenBalance: 0,
      successData: {
        tradeType: '',
        amount: 0,
        transactionHash: '',
        blockNumber: 0
      },
      // ÂêàÁ∫¶ÊµãËØïÁõ∏ÂÖ≥
      contractInitialized: false,
      contractLoading: false,
      contractStatus: null,
      testResults: [],
      userAddress: '',
      tokenPrice: '',
      userTokenBalance: '',
      tradeHistory: [],
      testAmount: '',
      // È°πÁõÆÊï∞ÊçÆ
      projectData: null,
      projectLoading: true,
      projectError: null,
      // ÈîôËØØÊ∂àÊÅØÊò†Â∞Ñ
      errorMessages: {
        'insufficient_balance': 'You have insufficient funds',
        'input_required': 'Please enter the amount',
        'login_required': 'Please login to your account',
        'wallet_connection_required': 'Please connect your wallet',
        'address_retrieval_failed': 'Unable to retrieve wallet address',
        'kyc_verification_required': 'Please complete KYC verification',
        'whitelist_required': 'Your wallet is not whitelisted',
        'transaction_failed': 'Transaction failed',
        'network_error': 'Network error occurred',
        'unknown_error': 'An unknown error occurred'
      }
    }
  },
  computed: {
    projectCode() {
      // ‰ºòÂÖà‰ΩøÁî®propsÔºåÁÑ∂ÂêéÊòØË∑ØÁî±ÂèÇÊï∞ÔºåÊúÄÂêéÊòØÈªòËÆ§ÂÄº
      const code = this.code || this.$route.params.code || this.$route.query.code
      console.log('üîç TradeProjectView: Ëé∑ÂèñÈ°πÁõÆ‰ª£Á†Å:', {
        props: this.code,
        routeParams: this.$route.params.code,
        routeQuery: this.$route.query.code,
        final: code
      })
      return code || 'RWA001'
    },
    
    // ÊéßÂà∂ÊåâÈíÆÊòæÁ§∫
    showBuyButton() {
      return this.tradeType === 'buy' || !this.isInterestTrade
    },
    
    showSellButton() {
      return this.tradeType === 'sell' && this.isInterestTrade
    },
    project() {
      // ‰ΩøÁî®‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÁöÑÈ°πÁõÆÊï∞ÊçÆ
      if (this.projectData) {
        console.log('üìä TradeProjectView: ‰ΩøÁî®Êï∞ÊçÆÂ∫ìÈ°πÁõÆÊï∞ÊçÆ:', this.projectData)
        return this.projectData
      }
      return null
    },
    projectData() {
      // ‰ªéProductDetailsInfoËé∑ÂèñÈ°πÁõÆÊï∞ÊçÆÔºà‰øùÁïô‰Ωú‰∏∫Â§áÁî®Ôºâ
      const product = this.project
      
      if (product) {
        console.log('üìä TradeProjectView: ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÈ°πÁõÆÊï∞ÊçÆ:', product)
        
        // ÊûÑÂª∫Á¨¶ÂêàÊ®°ÊùøÈúÄÊ±ÇÁöÑÊï∞ÊçÆÁªìÊûÑÔºåÂÆåÊï¥Êò†Â∞ÑProductDetailsInfo.js‰∏≠ÁöÑÊâÄÊúâÂ≠óÊÆµ
        return {
          // Âü∫Êú¨‰ø°ÊÅØ
          code: product.code,
          name: product.name,
          image: product.image || this.getProductImage(product.code),
          subtitle: product.subtitle,
          type: product.type,
          region: product.region,
          risk: product.risk,
          targetYield: product.targetYield,
          status: product.status,
          summary: product.summary,
          
          // ÊäïËµÑ‰ø°ÊÅØ
          totalOffering: product.totalOffering,
          subscribed: product.subscribed,
          totalSubscriptionTokens: product.totalSubscriptionTokens,
          subscribedTokens: product.subscribedTokens,
          
          // ËÆ°ÁÆóÊåáÊ†á
          metrics: {
            currentElaraPrice: this.calculateTokenPrice(product),
            collateralPropertyValue: product.valuation || 'TBA',
            rentalIncome: this.calculateRentalIncome(product),
            targetLoanYield: `${product.targetYield}% p.a.`
          },
          
          // Key Facts ÂÖ≥ÈîÆ‰ø°ÊÅØ
          loanAmount: product.loanAmount,
          annualInterestRate: product.annualInterestRate,
          loanTerm: product.loanTerm,
          ltv: product.ltv,
          drawdownDate: product.drawdownDate,
          earlyRepayment: product.earlyRepayment,
          repaymentArrangement: product.repaymentArrangement,
          
          // Parties Áõ∏ÂÖ≥‰∏ª‰Ωì
          issuer: product.issuer,
          pwShareholders: product.pwShareholders,
          lender: product.lender,
          borrower: product.borrower,
          guarantor: product.guarantor,
          
          // Disbursement & Interest ÊîæÊ¨æÂíåÂà©ÊÅØ
          disbursementMethod: product.disbursementMethod,
          interest: product.interest,
          earlyRepaymentDetails: product.earlyRepaymentDetails,
          maturityDate: product.maturityDate,
          
          // Collateral ÊäµÊäºÂìÅ
          propertyAddress: product.propertyAddress,
          valuation: product.valuation,
          securityRank: product.securityRank,
          
          // Default & Remedies ËøùÁ∫¶ÂíåË°•ÊïëÊé™ÊñΩ
          defaultInterestRate: product.defaultInterestRate,
          defaultTriggers: product.defaultTriggers,
          defaultProcess: product.defaultProcess,
          
          // On-Chain & Documents Èìæ‰∏äÂíåÊñáÊ°£
          issuerToken: product.issuerToken,
          loanToken: product.loanToken,
          valuationReport: product.valuationReport,
          mortgageDeed: product.mortgageDeed
        }
      }
      
      // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂØπÂ∫î‰∫ßÂìÅÔºåËøîÂõûÈªòËÆ§Êï∞ÊçÆ
      // return {
      //   code: this.projectCode,
      //   name: `${this.projectCode} Property Loan`,
      //   image: '/pics/TYMU.png',
      //   subtitle: 'Property Investment Opportunity',
      //   type: 'residential',
      //   region: 'Unknown',
      //   risk: 'medium',
      //   targetYield: 6.0,
      //   status: 'active',
      //   metrics: {
      //     currentElaraPrice: 'A$1.00',
      //     collateralPropertyValue: 'TBA',
      //     rentalIncome: 'TBA',
      //     targetLoanYield: '6.0% p.a.'
      //   }
      // }
    },
    canSubmit() {
      return this.tradeAmount && this.tradeAmount > 0 && !this.loading
    },
    
    // Ê†ºÂºèÂåñÁöÑÈîôËØØÊ∂àÊÅØ
    formattedError() {
      if (!this.error) return null
      
      // Â¶ÇÊûúÊúâÈîôËØØÁ±ªÂûãÔºå‰ΩøÁî®Êò†Â∞ÑÁöÑÊ∂àÊÅØ
      if (this.errorType && this.errorMessages[this.errorType]) {
        return this.errorMessages[this.errorType]
      }
      
      // Âê¶ÂàôËøîÂõûÂéüÂßãÈîôËØØÊ∂àÊÅØ
      return this.error
    },
    
    // ‰ªéWallet Activity LogËé∑ÂèñÂΩìÂâçÈ°πÁõÆÁöÑ‰∫§ÊòìËÆ∞ÂΩï
    projectTrades() {
      if (!this.walletActivity || !Array.isArray(this.walletActivity)) {
        return []
      }
      
      // ËøáÊª§Âá∫ÂΩìÂâçÈ°πÁõÆÁöÑbuy/sell‰∫§ÊòìËÆ∞ÂΩï
      return this.walletActivity.filter(activity => 
        (activity.type === 'buy' || activity.type === 'sell') && 
        activity.project_code === this.projectCode
      ).sort((a, b) => b.timestamp - a.timestamp) // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàó
    }
  },
  methods: {
    async loadProjectData() {
      try {
        this.projectLoading = true
        this.projectError = null
        console.log('üîÑ TradeProjectView: ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÈ°πÁõÆÊï∞ÊçÆ...', this.projectCode)
        
        const response = await productAPI.getProductByCode(this.projectCode)
        
        if (response.status === 0) {
          this.projectData = response.data
          console.log('‚úÖ TradeProjectView: È°πÁõÆÊï∞ÊçÆÂä†ËΩΩÊàêÂäü:', this.projectData)
        } else {
          this.projectError = response.message || 'Ëé∑ÂèñÈ°πÁõÆÊï∞ÊçÆÂ§±Ë¥•'
          console.error('‚ùå TradeProjectView: APIËøîÂõûÈîôËØØ:', response)
        }
      } catch (error) {
        this.projectError = 'ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÈ°πÁõÆÊï∞ÊçÆ'
        console.error('‚ùå TradeProjectView: Âä†ËΩΩÈ°πÁõÆÊï∞ÊçÆÂ§±Ë¥•:', error)
      } finally {
        this.projectLoading = false
      }
    },
    
    getProductImage(code) {
      const imageMap = {
        'RWA001': '/pics/TYMU.png',
        'RWA002': '/pics/SQNB.png',
        'RWA003': '/pics/LZYT.png',
        'YYD': '/pics/YYD.png',
        'COMP': '/pics/TYMU.png'
      }
      return imageMap[code] || '/pics/TYMU.png'
    },
    
    calculateTokenPrice(product) {
      // Âü∫‰∫éÁõÆÊ†áÊî∂ÁõäÁéáËÆ°ÁÆó‰ª£Â∏Å‰ª∑Ê†º
      const basePrice = 1.00
      const yieldMultiplier = (product.targetYield || 6.0) / 6.0
      const adjustedPrice = basePrice * yieldMultiplier
      return `A$${adjustedPrice.toFixed(2)}`
    },
    
    calculateRentalIncome(product) {
      // Âü∫‰∫éÊàø‰∫ß‰ª∑ÂÄºÂíåÊî∂ÁõäÁéá‰º∞ÁÆóÁßüÈáëÊî∂ÂÖ•
      if (!product.valuation) return 'TBA'
      
      const valuationStr = product.valuation.replace(/[A$,]/g, '')
      const valuation = parseFloat(valuationStr)
      const monthlyYield = (product.targetYield || 6.0) / 12 / 100
      const estimatedRental = valuation * monthlyYield
      
      return `A$${estimatedRental.toLocaleString('en-AU', { maximumFractionDigits: 0 })} / month`
    },
    
    calculateTotal() {
      if (!this.tradeAmount) return '0.00'
      const amount = parseFloat(this.tradeAmount)
      // const price = 1.00 // Âõ∫ÂÆö‰ª∑Ê†ºÔºå‰ªéÈ°πÁõÆÊï∞ÊçÆËé∑Âèñ
      return (amount * price).toFixed(2)
    },
    formatTime(timestamp) {
      return new Date(timestamp).toLocaleString()
    },

    // ‰ªéEtherscan APIËé∑Âèñ‰∫§ÊòìËØ¶ÊÉÖ
    async fetchTransactionDetails(txHash) {
      try {
        console.log('üîç Ê≠£Âú®‰ªéEtherscanËé∑Âèñ‰∫§ÊòìËØ¶ÊÉÖ:', txHash)
        
        // Etherscan Sepolia API (‰ΩøÁî®ÂÖçË¥πAPIÔºåÊó†ÈúÄAPI Key)
        const apiUrl = `https://api-sepolia.etherscan.io/api?module=proxy&action=eth_getTransactionByHash&txhash=${txHash}`
        
        const response = await fetch(apiUrl)
        const data = await response.json()
        
        if (data.result) {
          console.log('‚úÖ ÊàêÂäüËé∑Âèñ‰∫§ÊòìËØ¶ÊÉÖ:', data.result)
          
          // Ëé∑Âèñ‰∫§ÊòìÊî∂ÊçÆ
          const receiptUrl = `https://api-sepolia.etherscan.io/api?module=proxy&action=eth_getTransactionReceipt&txhash=${txHash}`
          const receiptResponse = await fetch(receiptUrl)
          const receiptData = await receiptResponse.json()
          
          return {
            success: true,
            transaction: data.result,
            receipt: receiptData.result,
            // ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ
            from: data.result.from,
            to: data.result.to,
            value: data.result.value,
            gasUsed: receiptData.result ? receiptData.result.gasUsed : null,
            gasPrice: data.result.gasPrice,
            blockNumber: data.result.blockNumber,
            blockHash: data.result.blockHash,
            status: receiptData.result ? receiptData.result.status : null
          }
        } else {
          console.warn('‚ö†Ô∏è ‰∫§ÊòìËØ¶ÊÉÖËé∑ÂèñÂ§±Ë¥•:', data.message)
          return {
            success: false,
            error: data.message || 'Failed to fetch transaction details'
          }
        }
      } catch (error) {
        console.error('‚ùå Ëé∑Âèñ‰∫§ÊòìËØ¶ÊÉÖÊó∂ÂèëÁîüÈîôËØØ:', error)
        return {
          success: false,
          error: error.message
        }
      }
    },


    cancelTrade() {
      this.$router.back()
    },

    // ÂàùÂßãÂåñ‰∫§ÊòìÁ±ªÂûã
    initializeTradeType() {
      const query = this.$route.query
      console.log('üîç TradeProjectView: Ê£ÄÊü•Ë∑ØÁî±ÂèÇÊï∞:', query)
      
      if (query.type === 'sell' && query.interest === 'true') {
        // Âá∫ÂîÆÂà©ÊÅØ
        this.tradeType = 'sell'
        this.isInterestTrade = true
        console.log('‚úÖ ËÆæÁΩÆ‰∏∫Âá∫ÂîÆÂà©ÊÅØÊ®°Âºè')
      } else if (query.type === 'buy') {
        // Ë¥≠‰π∞
        this.tradeType = 'buy'
        this.isInterestTrade = false
        console.log('‚úÖ ËÆæÁΩÆ‰∏∫Ë¥≠‰π∞Ê®°Âºè')
      } else {
        // ÈªòËÆ§Ë¥≠‰π∞Ê®°Âºè
        this.tradeType = 'buy'
        this.isInterestTrade = false
        console.log('‚úÖ ËÆæÁΩÆ‰∏∫ÈªòËÆ§Ë¥≠‰π∞Ê®°Âºè')
      }
    },

    // ÈÄâÊã©‰∫§ÊòìÁ±ªÂûãÂπ∂ÊâßË°åÂÆåÊï¥ÊµÅÁ®ã
    async selectTradeType(type) {
      // ËÆæÁΩÆ‰∫§ÊòìÁ±ªÂûã
      this.tradeType = type
      
      // Â¶ÇÊûúÊ≤°ÊúâËæìÂÖ•ÈáëÈ¢ùÔºåÊèêÁ§∫Áî®Êà∑ËæìÂÖ•
      if (!this.tradeAmount || this.tradeAmount <= 0) {
        this.errorType = 'input_required'
        this.error = `ËØ∑ÂÖàËæìÂÖ•${type === 'buy' ? 'Ë¥≠‰π∞' : 'Âá∫ÂîÆ'}Êï∞Èáè`
        this.addTestResult('error', 'Input Required', `ËØ∑ÂÖàËæìÂÖ•${type === 'buy' ? 'Ë¥≠‰π∞' : 'Âá∫ÂîÆ'}Êï∞Èáè`)
        return
      }

      console.log(`üöÄ ÂºÄÂßã${type}‰∫§ÊòìÊµÅÁ®ã...`)
      this.addTestResult('info', `üöÄ ÂºÄÂßã${type}‰∫§ÊòìÊµÅÁ®ã...`, `Ê≠£Âú®Â§ÑÁêÜ${type}‰∫§ÊòìÔºåÊï∞Èáè: ${this.tradeAmount} tokens`)
      
      try {
        this.loading = true
        this.error = null

        // 1. ÂêàÁ∫¶ÂàùÂßãÂåñ
        this.loadingStatus = 'Ê≠£Âú®ÂàùÂßãÂåñÊô∫ËÉΩÂêàÁ∫¶...'
        this.showLoadingModal = true
        this.addTestResult('info', 'üöÄ Initializing Contract', 'Ê≠£Âú®ÂàùÂßãÂåñÊô∫ËÉΩÂêàÁ∫¶...')
        
        await this.initializeContract()
        console.log('‚úÖ ÂêàÁ∫¶ÂàùÂßãÂåñÂÆåÊàê')
        this.addTestResult('success', 'Contract Initialized', 'Êô∫ËÉΩÂêàÁ∫¶ÂàùÂßãÂåñÂÆåÊàê')

        // 2. È™åËØÅÁî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
        if (!isLoggedIn()) {
          this.showLoadingModal = false
          this.loading = false
          this.errorType = 'login_required'
          this.error = 'ËØ∑ÂÖàÁôªÂΩïË¥¶Êà∑'
          this.addTestResult('error', 'Authentication Required', 'ËØ∑ÂÖàÁôªÂΩïË¥¶Êà∑')
          return
        }
        
        // 3. È™åËØÅÈí±ÂåÖÊòØÂê¶Â∑≤ËøûÊé•
        if (!this.isWalletConnected()) {
          this.showLoadingModal = false
          this.loading = false
          this.errorType = 'wallet_connection_required'
          this.error = 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ'
          this.addTestResult('error', 'Wallet Connection Required', 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ')
          return
        }
        
        // 4. Ëé∑ÂèñÈí±ÂåÖÂú∞ÂùÄ
        this.loadingStatus = 'Ê≠£Âú®Ëé∑ÂèñÈí±ÂåÖÂú∞ÂùÄ...'
        this.addTestResult('info', 'üë§ Getting User Address', 'Ê≠£Âú®Ëé∑ÂèñÈí±ÂåÖÂú∞ÂùÄ...')
        const userAddress = await this.getUserAddress()
        if (!userAddress) {
          this.showLoadingModal = false
          this.loading = false
          this.errorType = 'address_retrieval_failed'
          this.error = 'Êó†Ê≥ïËé∑ÂèñÈí±ÂåÖÂú∞ÂùÄÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖËøûÊé•'
          this.addTestResult('error', 'Address Retrieval Failed', 'Êó†Ê≥ïËé∑ÂèñÈí±ÂåÖÂú∞ÂùÄÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖËøûÊé•')
          return
        }
        console.log('‚úÖ Èí±ÂåÖÂú∞ÂùÄËé∑ÂèñÂÆåÊàê:', userAddress)
        this.addTestResult('success', 'User Address Retrieved', `Âú∞ÂùÄ: ${userAddress}`)
        
        // 5. È™åËØÅÂπ∂ËÆæÁΩÆKYCÁä∂ÊÄÅÔºàÁÆÄÂåñÔºöÈÄöËøáKYCÈ™åËØÅÁõ¥Êé•ËÆæÁΩÆ‰∏∫Level 2Ôºâ
        const kycStatus = getKycStatus()
        const kycLevel = getKycLevel()
        
        if (kycStatus !== KYC_STATUS.VERIFIED) {
          this.showLoadingModal = false
          this.loading = false
          this.errorType = 'kyc_verification_required'
          this.error = 'ËØ∑ÂÖàÂÆåÊàêKYCË∫´‰ªΩÈ™åËØÅ'
          this.addTestResult('error', 'KYC Verification Required', 'ËØ∑ÂÖàÂÆåÊàêKYCË∫´‰ªΩÈ™åËØÅ')
          return
        }
        
        // ÁÆÄÂåñÔºöKYCÈ™åËØÅÊàêÂäüÊó∂ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫Level 2
        if (kycLevel < KYC_LEVELS.LEVEL_2) {
          console.log(`üîß KYCÈ™åËØÅÊàêÂäüÔºåËá™Âä®ËÆæÁΩÆÁ∫ßÂà´‰∏∫ ${KYC_LEVELS.LEVEL_2}`)
          setKycLevel(KYC_LEVELS.LEVEL_2)
          this.addTestResult('info', 'KYC Level Set', `KYCÁ∫ßÂà´Â∑≤ËÆæÁΩÆ‰∏∫${KYC_LEVELS.LEVEL_2}`)
        }

        // 6. Ëé∑ÂèñÈí±ÂåÖ‰ª£Â∏Å‰ΩôÈ¢ù
        this.loadingStatus = `Ê≠£Âú®Ëé∑Âèñ${this.projectCode}‰ª£Â∏Å‰ΩôÈ¢ù...`
        this.addTestResult('info', 'üí∞ Getting Token Balance', `Ê≠£Âú®Ëé∑Âèñ${this.projectCode}‰ª£Â∏Å‰ΩôÈ¢ù...`)
        const balance = await contractService.getUserTokenBalance(userAddress, this.projectCode)
        this.userTokenBalance = parseInt(balance) || 0
        console.log(`‚úÖ ${this.projectCode}‰ª£Â∏Å‰ΩôÈ¢ùËé∑ÂèñÂÆåÊàê:`, this.userTokenBalance)
        this.addTestResult('success', 'Token Balance Retrieved', `${this.projectCode}‰ΩôÈ¢ù: ${this.userTokenBalance} tokens`)

        // 7. ÊØîËæÉ‰ΩôÈ¢ù‰∏éËÆ§Ë¥≠ÈáëÈ¢ùÔºà‰ªÖÂØπbuyÊìç‰ΩúÔºâ
        if (type === 'buy') {
          console.log(`üí∞ ${this.projectCode}‰ΩôÈ¢ùÊ£ÄÊü•: ${this.userTokenBalance} vs ${this.tradeAmount}`)
          this.addTestResult('info', 'üí∞ Checking Balance', `Ê£ÄÊü•${this.projectCode}‰ΩôÈ¢ù: ${this.userTokenBalance} vs ${this.tradeAmount}`)
          if (this.userTokenBalance < parseInt(this.tradeAmount)) {
            this.showLoadingModal = false
            this.loading = false
            this.showInsufficientBalanceModal = true
            this.addTestResult('error', 'Insufficient Balance', `${this.projectCode}‰ΩôÈ¢ù‰∏çË∂≥: ÂΩìÂâç${this.userTokenBalance}ÔºåÈúÄË¶Å${this.tradeAmount}`)
            return
          }
          console.log('‚úÖ ‰ΩôÈ¢ùÂÖÖË∂≥ÔºåÂèØ‰ª•ÁªßÁª≠‰∫§Êòì')
          this.addTestResult('success', 'Balance Check Passed', `${this.projectCode}‰ΩôÈ¢ùÂÖÖË∂≥: ${this.userTokenBalance} >= ${this.tradeAmount}`)
        }

        // 9. Á≠æËÆ¢Êô∫ËÉΩÂêàÁ∫¶
        this.loadingStatus = `Ê≠£Âú®‰∏éÊô∫ËÉΩÂêàÁ∫¶Á≠æËÆ¢${type === 'buy' ? 'Ë¥≠‰π∞' : 'Âá∫ÂîÆ'}ÂçèËÆÆ...`
        this.addTestResult('info', `üìù Executing ${type.toUpperCase()} Transaction`, `Ê≠£Âú®‰∏éÊô∫ËÉΩÂêàÁ∫¶Á≠æËÆ¢${type === 'buy' ? 'Ë¥≠‰π∞' : 'Âá∫ÂîÆ'}ÂçèËÆÆ...`)
        
        let result
        if (type === 'buy') {
          result = await contractService.buyTokens(parseInt(this.tradeAmount))
        } else {
          result = await contractService.sellTokens(parseInt(this.tradeAmount))
        }

        if (result.success) {
          console.log(`‚úÖ ${type}‰∫§ÊòìÊàêÂäü:`, result)
          
          // ÂÖ≥Èó≠Âä†ËΩΩÂºπÁ™ó
          this.showLoadingModal = false
          
          // ÂáÜÂ§á‰∫§ÊòìÊï∞ÊçÆ
      const tradeData = {
        projectCode: this.projectCode,
            tradeType: type,
            amount: parseInt(this.tradeAmount),
            price: result.tokenPrice || 1.00,
            total: result.totalCost || parseFloat(this.calculateTotal()),
            userAddress: userAddress,
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber,
            timestamp: Date.now()
          }
          
          // ÂàõÂª∫Âü∫Á°Ä‰∫§ÊòìËÆ∞ÂΩï
          const baseTradeData = {
            id: Date.now(),
            type: type, // ‰∫§ÊòìÁ±ªÂûã (buy/sell)
            amount: this.tradeAmount, // Áî®Êà∑ËæìÂÖ•ÁöÑtoken amount
            project_code: this.projectCode, // È°πÁõÆ‰ª£Á†Å
            project_name: this.projectData.name, // È°πÁõÆÂêçÁß∞
            timestamp: Date.now(), // ÂΩìÂâçÊó∂Èó¥Êà≥
            transactionHash: result.transactionHash
          }

          // ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩï
          this.notifyWalletActivity(baseTradeData)
          
          // ÊòæÁ§∫ÊàêÂäüÂºπÁ™ó
          this.showSuccessModal = true
          this.successData = {
            tradeType: type,
            amount: this.tradeAmount, // ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑtoken amount
            price: tradeData.price,
            total: tradeData.total,
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber
          }
          
          // Ê∑ªÂä†ÊàêÂäüÊµãËØïÁªìÊûú
          this.addTestResult('success', `${type.toUpperCase()} Transaction Successful`, `‰∫§ÊòìÊàêÂäüÂÆåÊàê`, {
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber,
            amount: tradeData.amount,
            price: result.tokenPrice,
            totalCost: result.totalCost,
            userAddress: userAddress
    })
    
    // ÈáçÁΩÆË°®Âçï
    this.tradeAmount = ''
        } else {
          // ÂÖ≥Èó≠Âä†ËΩΩÂºπÁ™ó
          this.showLoadingModal = false
          console.error(`‚ùå ${type}‰∫§ÊòìÂ§±Ë¥•:`, result.error)
          this.errorType = 'transaction_failed'
          this.error = result.error || `${type}‰∫§ÊòìÂ§±Ë¥•`
          this.addTestResult('error', `${type.toUpperCase()} Transaction Failed`, result.error || `${type}‰∫§ÊòìÂ§±Ë¥•`)
        }
        
      } catch (error) {
        // ÂÖ≥Èó≠Âä†ËΩΩÂºπÁ™ó
        this.showLoadingModal = false
        console.error('‚ùå ‰∫§ÊòìÊµÅÁ®ãÂ§±Ë¥•:', error)
        this.errorType = 'network_error'
        this.error = error.message
        this.addTestResult('error', 'Transaction Error', error.message)
      } finally {
        this.loading = false
      }
    },
    async submitTrade() {
      if (!this.canSubmit) return
      
      this.loading = true
      this.error = null
      
      try {
        // Ê∑ªÂä†ÊµãËØïÁªìÊûú - ÂºÄÂßã‰∫§Êòì
        this.addTestResult('info', `üöÄ ÂºÄÂßã${this.tradeType}‰∫§Êòì...`, `Ê≠£Âú®Â§ÑÁêÜ${this.tradeType}‰∫§ÊòìÔºåÊï∞Èáè: ${this.tradeAmount} tokens`)
        
        // 1. ÂêàÁ∫¶ÂàùÂßãÂåñ
        this.addTestResult('info', 'üöÄ Initializing Contract', 'Ê≠£Âú®ÂàùÂßãÂåñÊô∫ËÉΩÂêàÁ∫¶...')
        await this.initializeContract()
        this.addTestResult('success', 'Contract Initialized', 'Êô∫ËÉΩÂêàÁ∫¶ÂàùÂßãÂåñÂÆåÊàê')
        
        // 2. È™åËØÅÁî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
        if (!isLoggedIn()) {
          this.addTestResult('error', 'Authentication Required', 'ËØ∑ÂÖàÁôªÂΩïË¥¶Êà∑')
          this.loading = false
          return
        }
        
        // 3. È™åËØÅÈí±ÂåÖÊòØÂê¶Â∑≤ËøûÊé•
        if (!this.isWalletConnected()) {
          this.addTestResult('error', 'Wallet Connection Required', 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ')
          this.loading = false
          return
        }
        
        // 4. Ëé∑ÂèñÁî®Êà∑Èí±ÂåÖÂú∞ÂùÄ
        const userAddress = await this.getUserAddress()
        if (!userAddress) {
          this.addTestResult('error', 'Address Retrieval Failed', 'Êó†Ê≥ïËé∑ÂèñÈí±ÂåÖÂú∞ÂùÄÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖËøûÊé•')
          this.loading = false
          return
        }
        
        this.addTestResult('success', 'User Address Retrieved', `Âú∞ÂùÄ: ${userAddress}`)
        
        // 5. È™åËØÅÂπ∂ËÆæÁΩÆKYCÁä∂ÊÄÅÔºàÁÆÄÂåñÔºöÈÄöËøáKYCÈ™åËØÅÁõ¥Êé•ËÆæÁΩÆ‰∏∫Level 2Ôºâ
        const kycStatus = getKycStatus()
        const kycLevel = getKycLevel()
        
        if (kycStatus !== KYC_STATUS.VERIFIED) {
          this.addTestResult('error', 'KYC Verification Required', 'ËØ∑ÂÖàÂÆåÊàêKYCË∫´‰ªΩÈ™åËØÅ')
          this.loading = false
          return
        }
        
        // ÁÆÄÂåñÔºöKYCÈ™åËØÅÊàêÂäüÊó∂ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫Level 2
        if (kycLevel < KYC_LEVELS.LEVEL_2) {
          console.log(`üîß KYCÈ™åËØÅÊàêÂäüÔºåËá™Âä®ËÆæÁΩÆÁ∫ßÂà´‰∏∫ ${KYC_LEVELS.LEVEL_2}`)
          setKycLevel(KYC_LEVELS.LEVEL_2)
          this.addTestResult('info', 'KYC Level Set', `KYCÁ∫ßÂà´Â∑≤ËÆæÁΩÆ‰∏∫${KYC_LEVELS.LEVEL_2}`)
        }
        
        // 6. È™åËØÅÊòØÂê¶Âú®ÁôΩÂêçÂçï‰∏≠
        this.loadingStatus = 'Ê≠£Âú®Ê£ÄÊü•ÁôΩÂêçÂçïÁä∂ÊÄÅ...'
        this.addTestResult('info', 'üîç Checking Whitelist Status', 'Ê≠£Âú®Ê£ÄÊü•ÁôΩÂêçÂçïÁä∂ÊÄÅ...')
        const isWhitelisted = await this.checkWhitelistStatus(userAddress)
        if (!isWhitelisted) {
          this.showLoadingModal = false
          this.loading = false
          this.errorType = 'whitelist_required'
          this.error = 'ÊÇ®ÁöÑÈí±ÂåÖÂú∞ÂùÄÂ∞öÊú™Âä†ÂÖ•ÁôΩÂêçÂçïÔºåËØ∑ÂÖàÂÆåÊàêÁôΩÂêçÂçïÁî≥ËØ∑'
          this.addTestResult('error', 'Whitelist Required', 'ÊÇ®ÁöÑÈí±ÂåÖÂú∞ÂùÄÂ∞öÊú™Âä†ÂÖ•ÁôΩÂêçÂçïÔºåËØ∑ÂÖàÂÆåÊàêÁôΩÂêçÂçïÁî≥ËØ∑')
          return
        }
        this.addTestResult('success', 'Whitelist Check Passed', 'ÁôΩÂêçÂçïÈ™åËØÅÈÄöËøá')

        // 8. Â¶ÇÊûúÊòØBuyÊìç‰ΩúÔºåÊ£ÄÊü•‰ª£Â∏Å‰ΩôÈ¢ù
        if (this.tradeType === 'buy') {
          this.loadingStatus = 'Ê≠£Âú®Ëé∑ÂèñÁî®Êà∑‰ª£Â∏Å‰ΩôÈ¢ù...'
          this.showLoadingModal = true
          this.addTestResult('info', 'üí∞ Checking Token Balance', 'Ê≠£Âú®Ëé∑ÂèñÁî®Êà∑‰ª£Â∏Å‰ΩôÈ¢ù...')
          
          // Ëé∑ÂèñÁî®Êà∑‰ª£Â∏Å‰ΩôÈ¢ù
          const balance = await contractService.getUserTokenBalance(userAddress, this.projectCode)
          this.userTokenBalance = parseInt(balance) || 0
          
          console.log(`üí∞ Áî®Êà∑${this.projectCode}‰ª£Â∏Å‰ΩôÈ¢ù: ${this.userTokenBalance}, ËÆ§Ë¥≠Êï∞Èáè: ${this.tradeAmount}`)
          
          // Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶Ë∂≥Â§ü
          if (this.userTokenBalance < parseInt(this.tradeAmount)) {
            this.showLoadingModal = false
            this.loading = false
            this.showInsufficientBalanceModal = true
            this.addTestResult('error', 'Insufficient Balance', `${this.projectCode}‰ΩôÈ¢ù‰∏çË∂≥: ÂΩìÂâç${this.userTokenBalance}ÔºåÈúÄË¶Å${this.tradeAmount}`)
            return
          }
          
          // ‰ΩôÈ¢ùË∂≥Â§üÔºåÁªßÁª≠‰∫§Êòì
          this.loadingStatus = '‰ΩôÈ¢ùÂÖÖË∂≥ÔºåÊ≠£Âú®Â§ÑÁêÜ‰∫§Êòì...'
          this.addTestResult('success', 'Balance Check Passed', `${this.projectCode}‰ΩôÈ¢ùÂÖÖË∂≥: ${this.userTokenBalance} >= ${this.tradeAmount}`)
        }
      
        console.log(`üöÄ ÂºÄÂßã${this.tradeType}‰∫§Êòì...`)
        
        // 8. ÊâßË°å‰∫§Êòì - Êï¥ÂêàTest Buy/Test SellÁöÑÈÄªËæë
        let result
        if (this.tradeType === 'buy') {
          this.loadingStatus = 'Ê≠£Âú®‰∏éÊô∫ËÉΩÂêàÁ∫¶Á≠æËÆ¢Ë¥≠‰π∞ÂçèËÆÆ...'
          this.addTestResult('info', 'üìà Executing Buy Transaction', `Ê≠£Âú®Ë¥≠‰π∞ ${this.tradeAmount} tokens`)
          result = await contractService.buyTokens(parseInt(this.tradeAmount))
        } else {
          this.loadingStatus = 'Ê≠£Âú®‰∏éÊô∫ËÉΩÂêàÁ∫¶Á≠æËÆ¢Âá∫ÂîÆÂçèËÆÆ...'
          this.addTestResult('info', 'üìâ Executing Sell Transaction', `Ê≠£Âú®Âá∫ÂîÆ ${this.tradeAmount} tokens`)
          result = await contractService.sellTokens(parseInt(this.tradeAmount))
        }
        
        if (result.success) {
          console.log(`‚úÖ ${this.tradeType}‰∫§ÊòìÊàêÂäü:`, result)
          
          // ÂÖ≥Èó≠Âä†ËΩΩÂºπÁ™ó
          this.showLoadingModal = false
          
          // Ê∑ªÂä†ÊàêÂäüÊµãËØïÁªìÊûú - Êù•Ëá™Test Buy/SellÁöÑÈÄªËæë
          this.addTestResult('success', `${this.tradeType.toUpperCase()} Transaction Successful`, `Tx Hash: ${result.transactionHash}`, {
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber,
            amount: this.tradeAmount,
            price: result.tokenPrice,
            totalCost: result.totalCost
          })
          
          
          // ÂàõÂª∫Âü∫Á°Ä‰∫§ÊòìËÆ∞ÂΩï
          const baseTradeData = {
            id: Date.now(),
            type: this.tradeType, // ‰∫§ÊòìÁ±ªÂûã (buy/sell)
            amount: this.tradeAmount, // Áî®Êà∑ËæìÂÖ•ÁöÑtoken amount
            project_code: this.projectCode, // È°πÁõÆ‰ª£Á†Å
            project_name: this.projectData.name, // È°πÁõÆÂêçÁß∞
            timestamp: Date.now(), // ÂΩìÂâçÊó∂Èó¥Êà≥
            transactionHash: result.transactionHash
          }

          // ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩï
          this.notifyWalletActivity(baseTradeData)
          
          // ÊòæÁ§∫ÊàêÂäüÂºπÁ™ó
          this.showSuccessModal = true
          this.successData = {
            tradeType: this.tradeType,
            amount: this.tradeAmount, // ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑtoken amount
            price: result.tokenPrice || 1.00,
            total: result.totalCost || parseFloat(this.calculateTotal()),
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber
          }
          
          // ÈáçÁΩÆË°®Âçï
          this.tradeAmount = ''
        } else {
          // ÂÖ≥Èó≠Âä†ËΩΩÂºπÁ™ó
          this.showLoadingModal = false
          console.error(`‚ùå ${this.tradeType}‰∫§ÊòìÂ§±Ë¥•:`, result.error)
          this.errorType = 'transaction_failed'
          this.error = result.error || `${this.tradeType}‰∫§ÊòìÂ§±Ë¥•`
          this.addTestResult('error', `${this.tradeType.toUpperCase()} Transaction Failed`, result.error)
        }
        
      } catch (error) {
        // ÂÖ≥Èó≠Âä†ËΩΩÂºπÁ™ó
        this.showLoadingModal = false
        console.error('‚ùå ‰∫§ÊòìÂ§±Ë¥•:', error)
        this.errorType = 'network_error'
        this.error = error.message
        this.addTestResult('error', 'Transaction Error', error.message)
        this.$emit('notify', `Trade failed: ${error.message}`)
      } finally {
        this.loading = false
      }
    },
    
    
    
    // ‰ªélocalStorageÂä†ËΩΩWallet ActivityÊï∞ÊçÆ
    loadWalletActivity() {
      try {
        const savedActivity = localStorage.getItem('walletActivity')
        if (savedActivity) {
          this.walletActivity = JSON.parse(savedActivity)
          console.log('üìä TradeProjectView: Âä†ËΩΩWallet ActivityÊï∞ÊçÆ:', this.walletActivity.length, 'Êù°ËÆ∞ÂΩï')
        } else {
          this.walletActivity = []
          console.log('üìä TradeProjectView: Ê≤°ÊúâÊâæÂà∞Wallet ActivityÊï∞ÊçÆ')
        }
      } catch (error) {
        console.error('‚ùå TradeProjectView: Âä†ËΩΩWallet ActivityÊï∞ÊçÆÂ§±Ë¥•:', error)
        this.walletActivity = []
      }
    },
    
    // ÁõëÂê¨Wallet ActivityÊõ¥Êñ∞‰∫ã‰ª∂
    handleWalletActivityUpdate(event) {
      console.log('üì¢ TradeProjectView: Êî∂Âà∞Wallet ActivityÊõ¥Êñ∞ÈÄöÁü•:', event.detail)
      this.loadWalletActivity()
    },

    // Ëé∑ÂèñÁî®Êà∑Âú∞ÂùÄÔºàÁî®‰∫é‰∫§ÊòìÈ™åËØÅÔºâ
    async getUserAddress() {
      try {
        console.log('üîç TradeProjectView: Ê≠£Âú®Ëé∑ÂèñÁî®Êà∑Èí±ÂåÖÂú∞ÂùÄ...')
        
        // 1. ‰ºòÂÖà‰ªélocalStorageËé∑ÂèñWalletViewÁªëÂÆöÁöÑÈí±ÂåÖÂú∞ÂùÄ
        const savedAccounts = localStorage.getItem('walletBoundAccounts')
        if (savedAccounts) {
          try {
            const boundAddresses = JSON.parse(savedAccounts)
            if (boundAddresses && boundAddresses.length > 0) {
              // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÁªëÂÆöÁöÑÈí±ÂåÖÂú∞ÂùÄÔºàÊàñËÄÖÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÈÄâÊã©ÁâπÂÆöÁöÑÂú∞ÂùÄÔºâ
              const selectedAddress = boundAddresses[0]
              console.log('‚úÖ TradeProjectView: ‰ªéWalletViewËé∑ÂèñÁªëÂÆöÂú∞ÂùÄ:', selectedAddress)
              return selectedAddress
            }
          } catch (parseError) {
            console.warn('‚ö†Ô∏è TradeProjectView: Ëß£ÊûêwalletBoundAccountsÂ§±Ë¥•:', parseError)
          }
        }
        
        // 2. Â¶ÇÊûúlocalStorage‰∏≠Ê≤°ÊúâÁªëÂÆöÂú∞ÂùÄÔºåÂ∞ùËØï‰ªéuseWalletËé∑Âèñ
        const { fullAddress, connected } = useWallet()
        if (connected.value && fullAddress.value) {
          console.log('‚ö†Ô∏è TradeProjectView: ‰ΩøÁî®useWalletÂú∞ÂùÄ‰Ωú‰∏∫Â§áÁî®:', fullAddress.value)
          return fullAddress.value
        }
        
        // 3. ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•‰ªéethereumËé∑Âèñ
        if (typeof window.ethereum !== 'undefined') {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' })
          if (accounts && accounts.length > 0) {
            console.log('‚ö†Ô∏è TradeProjectView: ‰ΩøÁî®ethereumÂú∞ÂùÄ‰Ωú‰∏∫ÊúÄÂêéÂ§áÁî®:', accounts[0])
            return accounts[0]
          }
        }
        
        console.error('‚ùå TradeProjectView: Êó†Ê≥ï‰ªé‰ªª‰ΩïÊù•Ê∫êËé∑ÂèñÁî®Êà∑Âú∞ÂùÄ')
        return null
        
      } catch (error) {
        console.error('‚ùå TradeProjectView: Ëé∑ÂèñÁî®Êà∑Âú∞ÂùÄÂ§±Ë¥•:', error)
        return null
      }
    },
    
    // ÂÖ≥Èó≠ÊàêÂäüÂºπÁ™ó
    closeSuccessModal() {
      this.showSuccessModal = false
      this.successData = {
        tradeType: '',
        amount: 0,
        price: 0,
        total: 0,
        transactionHash: '',
        blockNumber: 0
      }
    },

    // ÂÖ≥Èó≠‰ΩôÈ¢ù‰∏çË∂≥ÂºπÁ™ó
    closeInsufficientBalanceModal() {
      this.showInsufficientBalanceModal = false
    },
    
    // Ê∏ÖÈô§ÈîôËØØÊ∂àÊÅØ
    clearError() {
      this.error = null
      this.errorType = null
    },
    
    // Ê†ºÂºèÂåñÂìàÂ∏åÂú∞ÂùÄ
    formatHash(hash) {
      if (!hash) return ''
      return `${hash.slice(0, 6)}...${hash.slice(-4)}`
    },
    
    // Â§çÂà∂ÂìàÂ∏åÂà∞Ââ™Ë¥¥Êùø
    async copyHash() {
      try {
        await navigator.clipboard.writeText(this.successData.transactionHash)
        this.$emit('notify', '‰∫§ÊòìÂìàÂ∏åÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
      } catch (error) {
        console.error('Â§çÂà∂Â§±Ë¥•:', error)
        this.$emit('notify', 'Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂')
      }
    },
    
    // Êü•ÁúãPortfolio
    viewPortfolio() {
      // ÂÖ≥Èó≠ÊàêÂäüÂºπÁ™ó
      this.closeSuccessModal()
      
      // Ë∑≥ËΩ¨Âà∞PortfolioÈ°µÈù¢
      this.$router.push('/portfolio')
    },
    
    // Ëé∑ÂèñÂΩìÂâçÈìæID
    getCurrentChainId() {
      // ËøôÈáåÂèØ‰ª•‰ªéÂêàÁ∫¶ÈÖçÁΩÆ‰∏≠Ëé∑Âèñ
      return 11155111 // SepoliaÊµãËØïÁΩë
    },

    // ========== ÂêàÁ∫¶ÊµãËØïÊñπÊ≥ï ==========
    
    // ÂàùÂßãÂåñÂêàÁ∫¶
    async initializeContract() {
      try {
        this.contractLoading = true
        this.addTestResult('info', 'üöÄ Initializing contract service...', 'Starting contract initialization')
        
        await contractService.initialize()
        this.contractInitialized = true
        
        this.contractStatus = {
          type: 'success',
          icon: '‚úÖ',
          message: 'Contract service initialized successfully!'
        }
        
        this.addTestResult('success', 'Contract Initialized', 'Contract service is ready', {
          initialized: true,
          timestamp: Date.now()
        })
        
      } catch (error) {
        this.contractStatus = {
          type: 'error',
          icon: '‚ùå',
          message: `Initialization failed: ${error.message}`
        }
        
        this.addTestResult('error', 'Contract Initialization Failed', error.message)
        console.error('Contract initialization failed:', error)
      } finally {
        this.contractLoading = false
      }
    },

    // Ëé∑ÂèñÁî®Êà∑Âú∞ÂùÄÔºàÊµãËØïÁî®Ôºâ
    async testGetUserAddress() {
      try {
        this.contractLoading = true
        this.addTestResult('info', 'üë§ Fetching user address...', 'Getting connected wallet address')
        
        // 1. ‰ºòÂÖà‰ªélocalStorageËé∑ÂèñWalletViewÁªëÂÆöÁöÑÈí±ÂåÖÂú∞ÂùÄ
        const savedAccounts = localStorage.getItem('walletBoundAccounts')
        if (savedAccounts) {
          try {
            const boundAddresses = JSON.parse(savedAccounts)
            if (boundAddresses && boundAddresses.length > 0) {
              this.userAddress = boundAddresses[0]
              this.addTestResult('success', 'User Address from WalletView', `Address: ${this.userAddress}`, {
                address: this.userAddress,
                shortAddress: this.formatAddress(this.userAddress),
                source: 'WalletView Bound Accounts',
                boundAccountsCount: boundAddresses.length
              })
              return
            }
          } catch (parseError) {
            this.addTestResult('warning', 'Parse walletBoundAccounts failed', parseError.message)
          }
        }
        
        // 2. Â¶ÇÊûúlocalStorage‰∏≠Ê≤°ÊúâÁªëÂÆöÂú∞ÂùÄÔºåÂ∞ùËØï‰ªéuseWalletËé∑Âèñ
        const { fullAddress, connected } = useWallet()
        if (connected.value && fullAddress.value) {
          this.userAddress = fullAddress.value
          this.addTestResult('warning', 'Address from useWallet (No bound accounts)', `Address: ${this.userAddress}`, {
            address: this.userAddress,
            shortAddress: this.formatAddress(this.userAddress),
            source: 'useWallet composable'
          })
          return
        }
        
        // 3. ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•‰ªéethereumËé∑Âèñ
        if (typeof window.ethereum !== 'undefined') {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' })
          if (accounts && accounts.length > 0) {
            this.userAddress = accounts[0]
            this.addTestResult('warning', 'Address from ethereum (Fallback)', `Address: ${this.userAddress}`, {
              address: this.userAddress,
              shortAddress: this.formatAddress(this.userAddress),
              source: 'ethereum.accounts'
            })
            return
          }
        }
        
        this.addTestResult('error', 'No Wallet Address Found', 'Please connect your wallet in WalletView first', {
          localStorageEmpty: !savedAccounts,
          useWalletConnected: connected.value,
          useWalletAddress: fullAddress.value,
          ethereumAvailable: typeof window.ethereum !== 'undefined'
        })
        
      } catch (error) {
        this.addTestResult('error', 'Failed to Get User Address', error.message)
        console.error('Failed to get user address:', error)
      } finally {
        this.contractLoading = false
      }
    },

    // Ëé∑Âèñ‰ª£Â∏Å‰ª∑Ê†º
    async getTokenPrice() {
      try {
        this.contractLoading = true
        this.addTestResult('info', 'üí∞ Fetching token price...', 'Getting current token price')
        
        this.tokenPrice = await contractService.getTokenPrice()
        
        this.addTestResult('success', 'Token Price Retrieved', `Price: ${this.tokenPrice} ETH`, {
          price: this.tokenPrice,
          currency: 'ETH'
        })
        
      } catch (error) {
        this.addTestResult('error', 'Failed to Get Token Price', error.message)
        console.error('Failed to get token price:', error)
      } finally {
        this.contractLoading = false
      }
    },

    // Ëé∑ÂèñÁî®Êà∑‰ª£Â∏Å‰ΩôÈ¢ù
    async getUserTokenBalance() {
      try {
        this.contractLoading = true
        this.addTestResult('info', 'üí≥ Fetching user token balance...', `Getting ${this.projectCode} token balance`)
        
        this.userTokenBalance = await contractService.getUserTokenBalance(null, this.projectCode)
        
        this.addTestResult('success', 'User Token Balance Retrieved', `${this.projectCode} Balance: ${this.userTokenBalance}`, {
          balance: this.userTokenBalance,
          address: this.userAddress,
          tokenSymbol: this.projectCode
        })
        
      } catch (error) {
        this.addTestResult('error', 'Failed to Get User Token Balance', error.message)
        console.error('Failed to get user token balance:', error)
      } finally {
        this.contractLoading = false
      }
    },

    // Ëé∑Âèñ‰∫§ÊòìÂéÜÂè≤
    async getTradeHistory() {
      try {
        this.contractLoading = true
        this.addTestResult('info', ' Fetching trade history...', 'Getting recent trade records')
        
        this.tradeHistory = await contractService.getTradeHistory()
        
        this.addTestResult('success', 'Trade History Retrieved', `Found ${this.tradeHistory.length} trade records`, {
          trades: this.tradeHistory,
          count: this.tradeHistory.length
        })
        
      } catch (error) {
        this.addTestResult('error', 'Failed to Get Trade History', error.message)
        console.error('Failed to get trade history:', error)
      } finally {
        this.contractLoading = false
      }
    },

    // ÊµãËØï‰π∞ÂÖ•‰∫§Êòì
    async testBuyTransaction() {
      try {
        this.contractLoading = true
        this.addTestResult('info', 'üìà Testing buy transaction...', `Testing buy of ${this.testAmount} tokens`)
        
        // È™åËØÅÊùÉÈôê
        if (!isLoggedIn()) {
          this.addTestResult('error', 'Authentication Required', 'ËØ∑ÂÖàÁôªÂΩïË¥¶Êà∑')
          return
        }
        
        if (!this.isWalletConnected()) {
          this.addTestResult('error', 'Wallet Connection Required', 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ')
          return
        }
        
        const userAddress = await this.getUserAddress()
        if (!userAddress) {
          this.addTestResult('error', 'Address Retrieval Failed', 'Êó†Ê≥ïËé∑ÂèñÈí±ÂåÖÂú∞ÂùÄÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖËøûÊé•')
          return
        }
        
        const kycStatus = getKycStatus()
        const kycLevel = getKycLevel()
        
        if (kycStatus !== KYC_STATUS.VERIFIED) {
          this.addTestResult('error', 'KYC Verification Required', 'ËØ∑ÂÖàÂÆåÊàêKYCË∫´‰ªΩÈ™åËØÅ')
          return
        }
        
        // KYCÈ™åËØÅÊàêÂäüÊó∂ÔºåÂ¶ÇÊûúÁ∫ßÂà´‰∏çË∂≥ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫Level 2
        if (kycLevel < KYC_LEVELS.LEVEL_2) {
          console.log(`üîß KYCÈ™åËØÅÊàêÂäüÔºåËá™Âä®ÂçáÁ∫ßÁ∫ßÂà´‰ªé ${kycLevel} Âà∞ ${KYC_LEVELS.LEVEL_2}`)
          setKycLevel(KYC_LEVELS.LEVEL_2)
          this.addTestResult('info', 'KYC Level Updated', `KYCÁ∫ßÂà´Â∑≤Ëá™Âä®‰ªé${kycLevel}ÂçáÁ∫ßÂà∞${KYC_LEVELS.LEVEL_2}`)
        }
        
        // const isWhitelisted = await this.checkWhitelistStatus(userAddress)
        // if (!isWhitelisted) {
        //   this.addTestResult('error', 'Whitelist Required', 'ÊÇ®ÁöÑÈí±ÂåÖÂú∞ÂùÄÂ∞öÊú™Âä†ÂÖ•ÁôΩÂêçÂçï')
        //   return
        // }
        
        const result = await contractService.buyTokens(this.testAmount)
        
        if (result.success) {
          this.addTestResult('success', 'Buy Transaction Successful', `Tx Hash: ${result.transactionHash}`, {
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber,
            amount: this.testAmount,
            price: result.tokenPrice,
            totalCost: result.totalCost
          })
          
          
          // ÂàõÂª∫Âü∫Á°Ä‰∫§ÊòìËÆ∞ÂΩï
          const baseTradeData = {
            id: Date.now(),
            type: 'buy',
            amount: this.testAmount, // ‰ΩøÁî®testAmount
            project_code: this.projectCode,
            project_name: this.projectData.name,
            timestamp: Date.now(),
            transactionHash: result.transactionHash
          }

          // ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩï
          this.notifyWalletActivity(baseTradeData)
        } else {
          this.addTestResult('error', 'Buy Transaction Failed', result.error)
        }
        
      } catch (error) {
        this.addTestResult('error', 'Buy Transaction Error', error.message)
        console.error('Buy transaction failed:', error)
      } finally {
        this.contractLoading = false
      }
    },

    // ÊµãËØïÂçñÂá∫‰∫§Êòì
    async testSellTransaction() {
      try {
        this.contractLoading = true
        this.addTestResult('info', 'üìâ Testing sell transaction...', `Testing sell of ${this.testAmount} tokens`)
        
        // È™åËØÅÊùÉÈôê
        if (!isLoggedIn()) {
          this.addTestResult('error', 'Authentication Required', 'ËØ∑ÂÖàÁôªÂΩïË¥¶Êà∑')
          return
        }
        
        if (!this.isWalletConnected()) {
          this.addTestResult('error', 'Wallet Connection Required', 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ')
          return
        }
        
        const userAddress = await this.getUserAddress()
        if (!userAddress) {
          this.addTestResult('error', 'Address Retrieval Failed', 'Êó†Ê≥ïËé∑ÂèñÈí±ÂåÖÂú∞ÂùÄÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖËøûÊé•')
          return
        }
        
        const kycStatus = getKycStatus()
        const kycLevel = getKycLevel()
        
        if (kycStatus !== KYC_STATUS.VERIFIED) {
          this.addTestResult('error', 'KYC Verification Required', 'ËØ∑ÂÖàÂÆåÊàêKYCË∫´‰ªΩÈ™åËØÅ')
          return
        }
        
        // KYCÈ™åËØÅÊàêÂäüÊó∂ÔºåÂ¶ÇÊûúÁ∫ßÂà´‰∏çË∂≥ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫Level 2
        if (kycLevel < KYC_LEVELS.LEVEL_2) {
          console.log(`üîß KYCÈ™åËØÅÊàêÂäüÔºåËá™Âä®ÂçáÁ∫ßÁ∫ßÂà´‰ªé ${kycLevel} Âà∞ ${KYC_LEVELS.LEVEL_2}`)
          setKycLevel(KYC_LEVELS.LEVEL_2)
          this.addTestResult('info', 'KYC Level Updated', `KYCÁ∫ßÂà´Â∑≤Ëá™Âä®‰ªé${kycLevel}ÂçáÁ∫ßÂà∞${KYC_LEVELS.LEVEL_2}`)
        }
        
        const isWhitelisted = await this.checkWhitelistStatus(userAddress)
        if (!isWhitelisted) {
          this.addTestResult('error', 'Whitelist Required', 'ÊÇ®ÁöÑÈí±ÂåÖÂú∞ÂùÄÂ∞öÊú™Âä†ÂÖ•ÁôΩÂêçÂçï')
          return
        }
        
        const result = await contractService.sellTokens(this.testAmount)
        
        if (result.success) {
          this.addTestResult('success', 'Sell Transaction Successful', `Tx Hash: ${result.transactionHash}`, {
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber,
            amount: this.testAmount,
            price: result.tokenPrice,
            totalCost: result.totalCost
          })
          
          
          // ÂàõÂª∫Âü∫Á°Ä‰∫§ÊòìËÆ∞ÂΩï
          const baseTradeData = {
            id: Date.now(),
            type: 'sell',
            amount: this.testAmount, // ‰ΩøÁî®testAmount
            project_code: this.projectCode,
            project_name: this.projectData.name,
            timestamp: Date.now(),
            transactionHash: result.transactionHash
          }

          // ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩï
          this.notifyWalletActivity(baseTradeData)
        } else {
          this.addTestResult('error', 'Sell Transaction Failed', result.error)
        }
        
      } catch (error) {
        this.addTestResult('error', 'Sell Transaction Error', error.message)
        console.error('Sell transaction failed:', error)
      } finally {
        this.contractLoading = false
      }
    },


    // Ê∑ªÂä†ÊµãËØïÁªìÊûú
    addTestResult(type, title, message, data = null) {
      const result = {
        type,
        title,
        message,
        data,
        timestamp: Date.now(),
        icon: this.getResultIcon(type)
      }
      
      this.testResults.unshift(result)
      
      // ÈôêÂà∂ÁªìÊûúÊï∞Èáè
      if (this.testResults.length > 20) {
        this.testResults = this.testResults.slice(0, 20)
      }
    },

    // Ëé∑ÂèñÁªìÊûúÂõæÊ†á
    getResultIcon(type) {
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      }
      return icons[type] || 'üìù'
    },

    // Ê∏ÖÈô§ÊµãËØïÁªìÊûú
    clearResults() {
      this.testResults = []
    },

    // ËøêË°åÊâÄÊúâÊµãËØï
    async runAllTests() {
      if (!this.contractInitialized) {
        await this.initializeContract()
      }
      
      if (this.contractInitialized) {
        await this.testGetUserAddress()
        await this.getTokenPrice()
        await this.getUserTokenBalance()
        await this.getTradeHistory()
        await this.testBuyTransaction(
          this.tradeAmount=3
        )
        await this.testSellTransaction(
          this.tradeAmount=3
        )
      }
    },

    // Ê†ºÂºèÂåñÂú∞ÂùÄ
    formatAddress(address) {
      if (!address) return ''
      return `${address.slice(0, 6)}...${address.slice(-4)}`
    },

    // Ê†ºÂºèÂåñETHÂÄº
    formatEtherValue(hexValue) {
      if (!hexValue) return '0'
      try {
        const wei = BigInt(hexValue)
        const eth = Number(wei) / Math.pow(10, 18)
        return eth.toFixed(6)
      } catch (error) {
        console.error('Error formatting ETH value:', error)
        return '0'
      }
    },

    // Ê†ºÂºèÂåñÂìàÂ∏åÂÄº
    formatHash(hash) {
      if (!hash) return 'N/A'
      return `${hash.slice(0, 10)}...${hash.slice(-8)}`
    },

    // Ê†ºÂºèÂåñEtherscanÊó∂Èó¥Êà≥
    formatEtherscanTime(timestamp) {
      if (!timestamp) return 'N/A'
      return new Date(timestamp).toLocaleString()
    },

    // Â§çÂà∂ÂìàÂ∏åÂÄº
    copyHash(hash) {
      if (!hash) return
      navigator.clipboard.writeText(hash).then(() => {
        console.log('‚úÖ ÂìàÂ∏åÂÄºÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
      }).catch(err => {
        console.error('‚ùå Â§çÂà∂Â§±Ë¥•:', err)
      })
    },

    // Ëé∑Âèñ‰∫§ÊòìÁ±ªÂûãÊòæÁ§∫ÊñáÊú¨
    getTradeTypeDisplay(type) {
      const typeMap = {
        'successful_trade': 'SUCCESS',
        'failed_trade': 'FAILED',
        'buy': 'BUY',
        'sell': 'SELL'
      }
      return typeMap[type] || type.toUpperCase()
    },

    // ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩï
    notifyWalletActivity(activityData) {
      try {
        console.log('üì¢ ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩï:', activityData)
        
        // ÈÄöËøálocalStorageÂ≠òÂÇ®Ê¥ªÂä®ËÆ∞ÂΩïÔºåWalletView‰ºöÁõëÂê¨Ëøô‰∏™ÂèòÂåñ
        const currentActivity = JSON.parse(localStorage.getItem('walletActivity') || '[]')
        currentActivity.unshift(activityData)
        
        // ÈôêÂà∂ÊúÄÂ§ö‰øùÂ≠ò50Êù°ËÆ∞ÂΩï
        if (currentActivity.length > 50) {
          currentActivity.splice(50)
        }
        
        localStorage.setItem('walletActivity', JSON.stringify(currentActivity))
        
        // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂ÔºåÈÄöÁü•WalletViewÂà∑Êñ∞
        window.dispatchEvent(new CustomEvent('walletActivityUpdated', {
          detail: activityData
        }))
        
        console.log('‚úÖ WalletViewÊ¥ªÂä®ËÆ∞ÂΩïÊõ¥Êñ∞ÈÄöÁü•Â∑≤ÂèëÈÄÅ')
        
      } catch (error) {
        console.error('‚ùå ÈÄöÁü•WalletViewÊõ¥Êñ∞Ê¥ªÂä®ËÆ∞ÂΩïÂ§±Ë¥•:', error)
      }
    },
    
    // Ê£ÄÊü•ÁôΩÂêçÂçïÁä∂ÊÄÅÔºàÁÆÄÂåñÈÄªËæëÔºâ
    async checkWhitelistStatus(address) {
      try {
        console.log('üîç Ê£ÄÊü•ÁôΩÂêçÂçïÁä∂ÊÄÅ:', address)
        
        // ÁÆÄÂåñÔºö‰ºòÂÖàÊ£ÄÊü•KYCÁä∂ÊÄÅ
        const kycLevel = getKycLevel()
        const kycStatus = getKycStatus()
        
        if (kycStatus === KYC_STATUS.VERIFIED && kycLevel >= KYC_LEVELS.LEVEL_2) {
          console.log('‚úÖ KYC Level 2Áî®Êà∑ÔºåËá™Âä®ÈÄöËøáÁôΩÂêçÂçïÊ£ÄÊü•')
          return true
        }
        
        // ‰ΩøÁî®contractServiceÊ£ÄÊü•ÁôΩÂêçÂçïÁä∂ÊÄÅ
        const statusData = await contractService.getWhitelistStatus(address)
        console.log('‚úÖ ÁôΩÂêçÂçïÁä∂ÊÄÅÊ£ÄÊü•ÁªìÊûú:', statusData)
        
        // Âè™ÊúâapprovedÁä∂ÊÄÅÊâçÂÖÅËÆ∏‰∫§Êòì
        return statusData.status === 'approved'
      } catch (error) {
        console.error('‚ùå Ê£ÄÊü•ÁôΩÂêçÂçïÁä∂ÊÄÅÂ§±Ë¥•:', error)
        return false
      }
    },

    // Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄÅ
    isWalletConnected() {
      try {
        const { connected, fullAddress } = useWallet()
        const isConnected = connected.value && fullAddress.value
        console.log('TradeProjectView: Èí±ÂåÖËøûÊé•Áä∂ÊÄÅÊ£ÄÊü•:', {
          connected: connected.value,
          hasAddress: !!fullAddress.value,
          address: fullAddress.value,
          isConnected
        })
        return isConnected
      } catch (error) {
        console.error('Ê£ÄÊü•Èí±ÂåÖËøûÊé•Áä∂ÊÄÅÂ§±Ë¥•:', error)
        return false
      }
    },
    
  },
  watch: {
    // ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñÔºåÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
    '$route'(to, from) {
      if (to.params.code !== from.params.code) {
        console.log('üîÑ TradeProjectView: Ë∑ØÁî±ÂèÇÊï∞ÂèòÂåñÔºåÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ')
        this.loadProjectData()
      }
    },
    
    // ÁõëÂê¨propsÂèòÂåñ
    code: {
      handler(newCode) {
        if (newCode) {
          console.log('üîÑ TradeProjectView: Props‰ª£Á†ÅÂèòÂåñÔºåÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ:', newCode)
          this.loadProjectData()
        }
      },
      immediate: true
    }
  },
  async mounted() {
    // Ê£ÄÊü•Ë∑ØÁî±ÂèÇÊï∞ÔºåËÆæÁΩÆ‰∫§ÊòìÁ±ªÂûã
    this.initializeTradeType()
    
    // Âä†ËΩΩÈ°πÁõÆÊï∞ÊçÆ
    await this.loadProjectData()
    
    // ÂàùÂßãÂåñuseWallet
    try {
      const { connected, fullAddress } = useWallet()
      console.log('TradeProjectView: Wallet connection status:', connected.value)
      console.log('TradeProjectView: Wallet address:', fullAddress.value)
    } catch (error) {
      console.error('TradeProjectView: Failed to initialize wallet:', error)
    }

    // ÂèØ‰ª•‰ªésessionStorageËé∑ÂèñÈ°πÁõÆ‰ø°ÊÅØ
    try {
      const storedProject = sessionStorage.getItem('lastProduct')
      if (storedProject) {
        const project = JSON.parse(storedProject)
        console.log('Loaded project from session:', project)
      }
    } catch (e) {
      console.log('No project data in session storage')
    }
    
    // Âä†ËΩΩWallet ActivityÊï∞ÊçÆ
    this.loadWalletActivity()
    
    // ÁõëÂê¨Wallet ActivityÊõ¥Êñ∞‰∫ã‰ª∂
    window.addEventListener('walletActivityUpdated', this.handleWalletActivityUpdate)
  },
  
  beforeUnmount() {
    // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
    window.removeEventListener('walletActivityUpdated', this.handleWalletActivityUpdate)
  }
}
</script>

<style scoped>
/* ‚Äî‚Äî ÈááÁî®PortfolioViewÁöÑÊ∑±Ëâ≤‰∏ªÈ¢ò ‚Äî‚Äî */
:root { 
  --bg:#f6f7fb; 
  --panel:#fff; 
  --text:#0b1020; 
  --muted:#6b7280; 
  --muted-2:#9aa3b2; 
  --border:#e6e8ef; 
  --shadow:0 6px 20px rgba(15,23,42,.06); 
  --primary:#3b82f6; 
  --primary-ink:#1e40af; 
  --danger:#ef4444; 
  --dark-bg:#141426;
  --dark-panel:#1f2937;
  --dark-border:#374151;
  --dark-text:#ffffff;
  --dark-muted:#9ca3af;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.trade-page {
  background: var(--dark-bg);
  min-height: 100vh;
  color: var(--dark-text);
}

/* È°∂ÈÉ®ÂØºËà™ */
.topbar {
  background: var(--dark-bg);
  border-bottom: 1px solid var(--dark-border);
  padding: 20px;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--dark-muted);
}

.crumb-back {
  border: none;
  background: transparent;
  cursor: pointer;
  color: var(--dark-muted);
  padding: 8px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.crumb-back:hover {
  background: var(--dark-panel);
  color: var(--dark-text);
}

.crumb {
  color: var(--dark-muted);
}

.crumb-current {
  color: var(--dark-text);
  font-weight: 600;
}

.sep {
  color: var(--dark-border);
}

.i {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπ */
.main-content {
  padding: 30px 0;
  display: grid;
  gap: 30px;
  grid-template-columns: 1fr 1fr;
  grid-template-areas: 
    "project-info project-info"
    "trade-form trade-history";
}

/* È°πÁõÆ‰ø°ÊÅØÂç°Áâá */
.project-info-card {
  grid-area: project-info;
  background: #1d1d36;
  border: 1px solid #2a2a4a;
  border-radius: 16px;
  padding: 30px;
  box-shadow: var(--shadow);
}

.project-header {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
}

.project-image {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  object-fit: cover;
}

.project-details {
  flex: 1;
}

.project-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--dark-text);
  margin: 0 0 8px 0;
}

.project-subtitle {
  color: var(--dark-muted);
  margin: 0 0 12px 0;
}

.project-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.meta-item {
  background: var(--dark-bg);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  color: var(--dark-muted);
  text-transform: capitalize;
  border: 1px solid var(--dark-border);
}

.project-metrics {
  display: grid;
  justify-content: center;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
}

.metric-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: #141426;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #2a2a4a;
  min-width: 0; /* ÂÖÅËÆ∏flex itemÊî∂Áº© */
}

.metric-label {
  font-size: 10px;
  color: #94a3b8;
  text-transform: uppercase;
  font-weight: 500;
  letter-spacing: 0.3px;
  line-height: 1.2;
}

.metric-value {
  font-size: 14px;
  font-weight: 600;
  color: #ffffff;
  line-height: 1.2;
  word-break: break-word; /* Â§ÑÁêÜÈïøÊñáÊú¨Êç¢Ë°å */
}

/* ‰∫§ÊòìË°®Âçï */
.trade-form-card {
  grid-area: trade-form;
  background: var(--dark-panel);
  border: 1px solid var(--dark-border);
  border-radius: 16px;
  padding: 0px;
  box-shadow: var(--shadow);
}

.form-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--dark-text);
  margin: 0 0 30px 0;
}

.form-section {
  margin-bottom: 30px;
  background: #1d1d36;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #2a2a4a;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #ffffff;
  margin: 0 0 16px 0;
}

.trade-type-buttons {
  display: flex;
  gap: 12px;
}

.trade-type-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 20px;
  border: 2px solid #2a2a4a;
  border-radius: 12px;
  background: #1d1d36;
  cursor: pointer;
  transition: all 0.2s;
  color: #ffffff;
}

.trade-type-btn:hover:not(:disabled) {
  border-color: var(--primary);
  background: #2a2a4a;
}

.trade-type-btn.active {
  border-color: var(--primary);
  background: var(--primary);
  color: white;
}

.trade-type-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.trade-type-btn:disabled:hover {
  border-color: #2a2a4a;
  background: #1d1d36;
  transform: none;
}

.btn-icon {
  font-size: 24px;
}

.btn-text {
  font-weight: 600;
  color: inherit;
}

.amount-input-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

.amount-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  font-size: 16px;
  background: #374151;
  color: var(--dark-text);
}

.amount-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.amount-unit {
  color: #94a3b8;
  font-weight: 500;
}

.amount-info {
  margin-top: 8px;
}

.info-text {
  font-size: 14px;
  color: #94a3b8;
}

.price-options {
  display: flex;
  gap: 20px;
  margin-bottom: 16px;
}

.price-option {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  color: #ffffff;
}

.price-option input[type="radio"] {
  margin: 0;
  accent-color: var(--primary);
}

.limit-price-input {
  display: flex;
  align-items: center;
  gap: 12px;
}

.price-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  font-size: 16px;
  background: var(--dark-bg);
  color: var(--dark-text);
}

.price-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.price-unit {
  color: #94a3b8;
  font-weight: 500;
}

.trade-summary {
  background: #1d1d36;
  border: 1px solid #2a2a4a;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.summary-item:last-child {
  margin-bottom: 0;
  font-weight: 600;
  border-top: 1px solid var(--dark-border);
  padding-top: 8px;
}

.summary-label {
  color: #94a3b8;
}

.summary-value {
  color: #ffffff;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn.secondary {
  background: #1d1d36;
  color: #ffffff;
  border: 1px solid #2a2a4a;
}

.btn.secondary:hover {
  background: #2a2a4a;
}

.btn.primary {
  background: #f59e0b;
  color: white;
  border: 1px solid #f59e0b;
}

.btn.primary:hover {
  background: #d97706;
  border-color: #d97706;
}

.btn.primary:disabled {
  background: #6b7280;
  border-color: #6b7280;
  cursor: not-allowed;
  opacity: 0.5;
}

/* ‰∫§ÊòìÂéÜÂè≤ */
.trade-history-card {
  grid-area: trade-history;
  background: #1d1d36;
  border: 1px solid #2a2a4a;
  border-radius: 16px;
  padding: 30px;
  box-shadow: var(--shadow);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: #ffffff;
  margin: 0 0 20px 0;
}

.card-header {
  margin-bottom: 20px;
}

.hash-value {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  cursor: pointer;
  color: #3b82f6;
  text-decoration: underline;
}

.hash-value:hover {
  color: #2563eb;
}

.status-success {
  color: #10b981;
  font-weight: 600;
}

.status-failed {
  color: #ef4444;
  font-weight: 600;
}

.trade-type.successful_trade {
  background: #10b981;
  color: white;
}

.trade-type.failed_trade {
  background: #ef4444;
  color: white;
}

.trade-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.trade-item {
  padding: 16px;
  border: 1px solid #2a2a4a;
  border-radius: 8px;
  margin-bottom: 12px;
  background: #141426;
  transition: all 0.2s ease;
}

.trade-item:hover {
  background: #1d1d36;
  border-color: var(--primary);
}

.trade-item:last-child {
  margin-bottom: 0;
}

.trade-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.trade-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}

.trade-type {
  font-weight: 600;
  font-size: 14px;
  padding: 6px 12px;
  border-radius: 6px;
  text-transform: uppercase;
}

.trade-type.buy {
  background: #10b981;
  color: white;
}

.trade-type.sell {
  background: #ef4444;
  color: white;
}

.trade-time {
  font-size: 12px;
  color: #9ca3af;
}

.trade-amount-section,
.trade-price-section,
.trade-total-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.label {
  font-size: 13px;
  color: #9ca3af;
  font-weight: 500;
}

.value {
  font-size: 14px;
  color: #e5e7eb;
  font-weight: 600;
}

.trade-total-section .value {
  color: #10b981;
  font-size: 16px;
}

.trade-footer {
  display: flex;
  justify-content: flex-end;
}

.tx-link {
  font-size: 12px;
  color: #3b82f6;
  text-decoration: none;
  padding: 4px 8px;
  border-radius: 4px;
  background: rgba(59, 130, 246, 0.1);
  transition: all 0.2s ease;
}

.tx-link:hover {
  background: rgba(59, 130, 246, 0.2);
  text-decoration: none;
}

.trade-details {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
}

.trade-price {
  font-weight: 600;
  color: #ffffff;
}

.trade-time {
  font-size: 12px;
  color: #94a3b8;
}

/* ÈîôËØØ‰ø°ÊÅØÊ†∑Âºè */
.error-message {
  margin-top: 16px;
  padding: 12px 16px;
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fecaca;
  border-radius: 8px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.error-icon {
  font-size: 16px;
  flex-shrink: 0;
}

.error-text {
  flex: 1;
}

/* Âä†ËΩΩÂíåÁ©∫Áä∂ÊÄÅÊ†∑Âºè */
.loading-message, .no-trades {
  text-align: center;
  padding: 40px 20px;
  color: #94a3b8;
  font-style: italic;
}

/* ‰∫§ÊòìÈìæÊé•Ê†∑Âºè */
.tx-link {
  color: #3b82f6;
  text-decoration: none;
  font-size: 12px;
  margin-top: 4px;
  display: block;
}

.tx-link:hover {
  text-decoration: underline;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .main-content {
    grid-template-columns: 1fr;
    grid-template-areas: 
      "project-info"
      "trade-form"
      "trade-history";
  }
  
  .project-header {
    flex-direction: column;
    text-align: center;
  }
  
  .project-metrics {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .metric-item {
    padding: 8px;
  }
  
  .metric-label {
    font-size: 9px;
  }
  
  .metric-value {
    font-size: 12px;
  }
  
  .trade-type-buttons {
    flex-direction: column;
  }
}

/* Â∞èÂ±èÂπïËÆæÂ§á */
@media (max-width: 480px) {
  .project-metrics {
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
  }
  
  .metric-item {
    padding: 6px;
  }
  
  .metric-label {
    font-size: 8px;
  }
  
  .metric-value {
    font-size: 11px;
  }
}

/* ========== ÂêàÁ∫¶ÊµãËØïÈù¢ÊùøÊ†∑Âºè ========== */
.contract-test-panel {
  background: #1d1d36;
  border: 1px solid #2a2a4a;
  border-radius: 16px;
  width: 50%;
  padding: 30px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 2px 8px rgba(94, 103, 124, 0.04);
  max-height: 800px;
  overflow-y: auto;
}

.test-status {
  margin-bottom: 20px;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border-radius: 8px;
  font-weight: 600;
}

.status-indicator.success {
  background: #064e3b;
  color: #10b981;
  border: 1px solid #10b981;
}

.status-indicator.error {
  background: #7f1d1d;
  color: #ef4444;
  border: 1px solid #ef4444;
}

.status-indicator.info {
  background: #1e3a8a;
  color: #3b82f6;
  border: 1px solid #3b82f6;
}

.status-icon {
  font-size: 16px;
}

.status-text {
  font-size: 14px;
}

/* ÊµãËØïÂå∫ÂüüÂ∏ÉÂ±Ä */
.test-area {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.test-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 200px;
  flex-shrink: 0;
}

.test-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border: 1px solid #2a2a4a;
  border-radius: 8px;
  background: #141426;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  font-weight: 500;
}

.test-btn:hover:not(:disabled) {
  border-color: #4f46e5;
  background: #1e1e3a;
  transform: translateX(4px);
}

.test-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.test-btn.active {
  border-color: #10b981;
  background: #064e3b;
  color: #10b981;
}

.btn-icon {
  font-size: 18px;
  width: 20px;
  text-align: center;
}

.btn-text {
  flex: 1;
}

.test-results {
  flex: 1;
  max-height: 400px;
  overflow-y: auto;
  background: #141426;
  border: 1px solid #2a2a4a;
  border-radius: 8px;
  padding: 16px;
}

.loading-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  color: #94a3b8;
  font-size: 14px;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid #2a2a4a;
  border-top: 2px solid #4f46e5;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.results-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.result-item {
  padding: 12px;
  border-radius: 8px;
  border: 1px solid;
  font-size: 13px;
}

.result-item.success {
  background: #064e3b;
  border-color: #10b981;
  color: #d1fae5;
}

.result-item.error {
  background: #7f1d1d;
  border-color: #ef4444;
  color: #fecaca;
}

.result-item.info {
  background: #1e3a8a;
  border-color: #3b82f6;
  color: #dbeafe;
}

.result-item.warning {
  background: #78350f;
  border-color: #f59e0b;
  color: #fef3c7;
}

.result-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.result-icon {
  font-size: 14px;
}

.result-title {
  font-weight: 600;
  flex: 1;
}

.result-time {
  font-size: 11px;
  opacity: 0.7;
}

.result-data {
  margin: 8px 0;
}

.result-data pre {
  background: rgba(0, 0, 0, 0.2);
  padding: 8px;
  border-radius: 4px;
  font-size: 11px;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-all;
}

.result-message {
  margin-top: 4px;
  opacity: 0.9;
}

.no-results {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 40px 20px;
  color: #94a3b8;
  text-align: center;
}

.no-results-icon {
  font-size: 32px;
  opacity: 0.5;
}

.no-results-text {
  font-size: 14px;
  font-style: italic;
}

.quick-actions {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.action-btn {
  padding: 8px 16px;
  border: 1px solid #2a2a4a;
  border-radius: 6px;
  background: #141426;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 12px;
  font-weight: 500;
}

.action-btn:hover {
  border-color: #4f46e5;
  background: #1e1e3a;
}

.action-btn.secondary {
  border-color: #6b7280;
  color: #9ca3af;
}

.action-btn.secondary:hover {
  border-color: #9ca3af;
  background: #374151;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .contract-test-panel {
    margin-top: 20px;
  }
  
  .test-area {
    flex-direction: column;
    gap: 16px;
  }
  
  .test-buttons {
    min-width: auto;
  }
}

@media (max-width: 768px) {
  .test-area {
    flex-direction: column;
    gap: 12px;
  }
  
  .test-buttons {
    gap: 6px;
  }
  
  .test-btn {
    padding: 10px 12px;
    font-size: 13px;
  }
  
  .btn-icon {
    font-size: 16px;
  }
  
  .test-results {
    max-height: 300px;
    padding: 12px;
  }
  
  .result-item {
    padding: 10px;
    font-size: 12px;
  }
  
  .quick-actions {
    flex-direction: column;
  }
  
  .action-btn {
    padding: 10px;
    font-size: 13px;
  }
}

/* ÂºπÁ™óÂü∫Á°ÄÊ†∑Âºè - Á¨¶ÂêàhomepageÊ∑±Ëâ≤‰∏ªÈ¢òÈ£éÊ†º */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10, 10, 26, 0.8);
  backdrop-filter: blur(8px);
  display: grid;
  place-items: center;
  z-index: 1000;
}

.modal-content {
  width: min(500px, 90vw);
  background: rgba(20, 20, 40, 0.98);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(138, 43, 226, 0.2);
  border-radius: 18px;
  padding: 40px 32px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  max-height: 700px;
  max-width: 500px;
  overflow-y: auto;
  position: relative;
}

.modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 20%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(75, 0, 130, 0.1) 0%, transparent 50%);
  border-radius: 18px;
  pointer-events: none;
  z-index: -1;
}

.modal-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 0 0 28px 0;
  border-bottom: 1px solid rgba(138, 43, 226, 0.2);
  margin-bottom: 28px;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  color: #ffffff;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.modal-body {
  padding: 0;
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 28px;
  padding-top: 28px;
  border-top: 1px solid rgba(138, 43, 226, 0.2);
}

/* ‰∫§ÊòìÊàêÂäüÂºπÁ™óÊ†∑Âºè - Á¨¶ÂêàhomepageÊ∑±Ëâ≤‰∏ªÈ¢òÈ£éÊ†º */
.success-modal {
  text-align: center;
  padding: 0;
}

.success-icon {
  font-size: 64px;
  color: #16a34a;
  margin-bottom: 24px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  filter: drop-shadow(0 0 8px rgba(22, 163, 74, 0.3));
}

.success-details {
  background: rgba(138, 43, 226, 0.05);
  border: 1px solid rgba(138, 43, 226, 0.2);
  border-radius: 12px;
  padding: 24px;
  margin: 28px 0;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(138, 43, 226, 0.1);
}

.detail-item:last-child {
  border-bottom: none;
}

.detail-label {
  color: #8ca0c3;
  font-size: 14px;
  font-weight: 500;
}

.detail-value {
  color: #ffffff;
  font-size: 14px;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.hash-value {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  cursor: pointer;
  color: #8a2be2;
  text-decoration: underline;
  background: rgba(138, 43, 226, 0.1);
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid rgba(138, 43, 226, 0.2);
}

.hash-value:hover {
  color: #a855f7;
  background: rgba(138, 43, 226, 0.2);
}

/* ‰ΩôÈ¢ù‰∏çË∂≥ÂºπÁ™óÊ†∑Âºè */
.error-modal {
  border-left: 4px solid #ef4444;
}

.error-icon {
  font-size: 24px;
  color: #ef4444;
}

.error-message {
  text-align: center;
}

.error-message p {
  margin: 8px 0;
  color: #64748b;
}

.error-message strong {
  color: #1e293b;
  font-weight: 600;
}

/* Âä†ËΩΩ‰∏≠ÂºπÁ™óÊ†∑Âºè - Á¨¶ÂêàhomepageÊ∑±Ëâ≤‰∏ªÈ¢òÈ£éÊ†º */
.loading-modal {
  text-align: center;
  padding: 0;
}

.loading-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 64px;
  height: 64px;
  margin: 0 auto 24px;
  background: rgba(138, 43, 226, 0.1);
  border-radius: 50%;
  border: 2px solid rgba(138, 43, 226, 0.3);
}

.loading-icon .spinner {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(138, 43, 226, 0.2);
  border-top: 3px solid #8a2be2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-message {
  text-align: center;
}

.loading-message p {
  margin: 12px 0;
  color: #e0e0e0;
  font-size: 16px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.loading-status {
  font-weight: 600;
  color: #8a2be2;
  font-style: italic;
  font-size: 16px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ÂºπÁ™óÊåâÈíÆÊ†∑Âºè - Á¨¶ÂêàhomepageÈ£éÊ†º */
.modal-footer .btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 20px;
  border-radius: 12px;
  border: 1px solid var(--border);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
}

.modal-footer .btn.primary {
  background: var(--brand);
  color: #fff;
  border-color: transparent;
}

.modal-footer .btn.primary:hover {
  background: var(--brand-700);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.modal-footer .btn.secondary {
  background: rgba(20, 20, 40, 0.8);
  color: #e0e0e0;
  border-color: rgba(138, 43, 226, 0.3);
}

.modal-footer .btn.secondary:hover {
  border-color: rgba(138, 43, 226, 0.6);
  background: rgba(138, 43, 226, 0.1);
  transform: translateY(-1px);
}
</style>
