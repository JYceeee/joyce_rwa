<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask交易测试</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>
    <h1>MetaMask交易测试</h1>
    
    <div id="status">等待连接钱包...</div>
    
    <button id="connectBtn" onclick="connectWallet()">连接MetaMask</button>
    <button id="testBtn" onclick="testTransaction()" disabled>测试交易</button>
    
    <div id="result"></div>

    <script>
        let provider, signer, userAddress;
        
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('请安装MetaMask扩展');
                    return;
                }
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('status').textContent = `已连接: ${userAddress}`;
                document.getElementById('testBtn').disabled = false;
                
            } catch (error) {
                console.error('连接失败:', error);
                alert('连接失败: ' + error.message);
            }
        }
        
        async function testTransaction() {
            try {
                // 测试参数
                const loanIssuerAddress = '0x1234567890123456789012345678901234567890'; // 测试地址
                const amount = '0.001'; // 0.001 ETH
                const amountInWei = ethers.utils.parseEther(amount);
                
                console.log('交易参数:', {
                    from: userAddress,
                    to: loanIssuerAddress,
                    value: amountInWei.toString()
                });
                
                // 构建交易
                const tx = {
                    to: loanIssuerAddress,
                    value: amountInWei,
                    gasLimit: 21000
                };
                
                // 发送交易
                const txResponse = await signer.sendTransaction(tx);
                console.log('交易已发送:', txResponse.hash);
                
                document.getElementById('result').innerHTML = `
                    <h3>交易已发送</h3>
                    <p>交易哈希: ${txResponse.hash}</p>
                    <p>等待确认...</p>
                `;
                
                // 等待确认
                const receipt = await txResponse.wait();
                console.log('交易已确认:', receipt);
                
                document.getElementById('result').innerHTML = `
                    <h3>交易已确认</h3>
                    <p>交易哈希: ${receipt.transactionHash}</p>
                    <p>区块号: ${receipt.blockNumber}</p>
                    <p>Gas使用量: ${receipt.gasUsed.toString()}</p>
                    <p>状态: ${receipt.status === 1 ? '成功' : '失败'}</p>
                `;
                
            } catch (error) {
                console.error('交易失败:', error);
                document.getElementById('result').innerHTML = `
                    <h3>交易失败</h3>
                    <p>错误: ${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>
