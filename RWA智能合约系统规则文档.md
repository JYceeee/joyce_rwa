# RWA智能合约系统规则文档

## 系统概述

本RWA（Real World Assets）智能合约系统是一个基于以太坊的合规化数字资产交易平台，支持房地产抵押贷款的代币化、交易和管理。系统采用模块化设计，包含KYC验证、合规代币、贷款发行和交易管理等功能。

## 核心合约架构

### 1. KYCRegistry.sol - KYC注册表合约

**功能**：管理用户身份验证和合规状态

**核心规则**：
- **KYC等级系统**：
  - `0` = NONE（无验证）
  - `1` = BASIC（基础验证）
  - `2` = FULL（完整验证）
  - `255` = BLOCKED（被阻止）

- **权限控制**：
  - 只有合约所有者可以设置KYC等级
  - 支持EIP-712签名验证方式设置KYC等级
  - 防止重放攻击（nonce机制）

- **状态管理**：
  - 用户可以同时被阻止和设置KYC等级
  - 被阻止的用户无法进行任何操作
  - KYC等级可以动态调整

### 2. CompliantERC20.sol - 合规ERC20代币合约

**功能**：基于KYC验证的ERC20代币实现

**核心规则**：
- **KYC检查**：所有转账操作都需要验证发送方和接收方的KYC等级
- **暂停机制**：支持紧急暂停所有转账操作
- **等级要求**：可配置最低KYC等级要求
- **合规验证**：
  - 检查用户是否被阻止
  - 验证KYC等级是否满足要求
  - 防止向零地址转账

### 3. CertificateToken.sol - 证书代币合约

**功能**：可铸造/销毁的合规代币，用于代表贷款本金和利息

**核心规则**：
- **控制器模式**：只有指定的控制器可以铸造和销毁代币
- **权限分离**：代币所有者可以更换控制器
- **合规继承**：继承CompliantERC20的所有合规规则

### 4. LoanIssuer.sol - 贷款发行合约

**功能**：管理贷款生命周期和代币发行

**核心规则**：
- **贷款创建**：
  - 只有合约所有者可以创建贷款
  - 创建贷款时自动铸造本金代币给持有人
  - 验证持有人KYC等级和阻止状态

- **利息管理**：
  - 只有合约所有者可以铸造利息代币
  - 利息金额由链下计算，链上执行
  - 验证接收方KYC等级

- **赎回机制**：
  - 用户可以燃烧本金和利息代币进行赎回
  - 现金结算在链下进行
  - 支持部分赎回

- **贷款结清**：
  - 只有合约所有者可以结清贷款
  - 结清后禁止进一步计息和赎回

## 业务规则

### 1. 用户准入规则

**KYC验证要求**：
- 所有用户必须通过KYC验证才能参与交易
- 不同操作需要不同的KYC等级：
  - 基础交易：KYC等级 ≥ 1
  - 高级操作：KYC等级 ≥ 2
  - 贷款管理：KYC等级 ≥ 2

**白名单机制**：
- 支持用户白名单管理
- 被阻止的用户无法进行任何操作
- 支持动态添加/移除用户

### 2. 代币交易规则

**转账限制**：
- 所有转账都需要KYC验证
- 被阻止的用户无法发送或接收代币
- 防止向零地址转账

**价格机制**：
- 代币价格由智能合约管理
- 支持动态价格调整
- 价格查询失败时使用默认价格

### 3. 贷款管理规则

**贷款创建**：
- 贷款ID自动递增
- 支持多种贷款参数配置
- 自动铸造本金代币

**利息计算**：
- 利息由链下计算，链上执行
- 支持定期利息发放
- 利息代币独立管理

**风险控制**：
- 支持贷款结清机制
- 防止重复操作
- 状态验证确保操作合法性

## 安全机制

### 1. 权限控制

**多级权限**：
- 合约所有者：最高权限，可管理所有功能
- 控制器：可铸造/销毁代币
- 普通用户：只能进行转账和赎回

**权限验证**：
- 所有关键操作都有权限检查
- 使用modifier确保权限正确性
- 防止权限提升攻击

### 2. 状态管理

**状态一致性**：
- 所有状态变更都有事件记录
- 支持状态查询和验证
- 防止状态不一致

**暂停机制**：
- 支持紧急暂停所有操作
- 只有所有者可以控制暂停状态
- 暂停期间禁止所有转账

### 3. 数据完整性

**输入验证**：
- 所有输入参数都有验证
- 防止无效数据进入系统
- 使用require确保条件满足

**溢出保护**：
- 使用unchecked块处理已知安全的计算
- 防止整数溢出攻击
- 确保计算正确性

## 事件系统

### 1. 核心事件

**KYC事件**：
- `SetLevel`：KYC等级设置
- `Block`：用户阻止状态变更
- `SetSigner`：签名者设置

**代币事件**：
- `Transfer`：代币转账
- `Approval`：授权变更
- `RequiredKycLevel`：KYC等级要求变更
- `Paused`：暂停状态变更

**贷款事件**：
- `CreateLoan`：贷款创建
- `MintInterest`：利息铸造
- `Redeem`：代币赎回
- `CloseLoan`：贷款结清

### 2. 事件监听

**前端集成**：
- 监听所有关键事件
- 实时更新用户界面
- 提供交易状态反馈

**后端处理**：
- 记录所有事件到数据库
- 触发相关业务逻辑
- 生成审计报告

## 部署和配置

### 1. 部署顺序

1. 部署KYCRegistry合约
2. 部署本金代币（CertificateToken）
3. 部署利息代币（CertificateToken）
4. 部署LoanIssuer合约
5. 配置合约权限和控制器

### 2. 初始化配置

**KYC设置**：
- 设置KYC签名者
- 配置默认KYC等级要求
- 初始化用户白名单

**代币配置**：
- 设置代币名称和符号
- 配置KYC等级要求
- 设置暂停状态

**贷款配置**：
- 绑定控制器到代币合约
- 配置贷款参数
- 设置权限管理

## 升级和维护

### 1. 合约升级

**代理模式**：
- 支持合约逻辑升级
- 保持状态数据不变
- 确保向后兼容性

**权限转移**：
- 支持所有权转移
- 安全的权限交接流程
- 防止权限丢失

### 2. 监控和维护

**事件监控**：
- 实时监控所有事件
- 异常情况告警
- 性能指标统计

**数据备份**：
- 定期备份合约状态
- 事件数据归档
- 灾难恢复准备

## 合规要求

### 1. 监管合规

**KYC/AML**：
- 符合反洗钱要求
- 身份验证标准
- 交易监控机制

**数据保护**：
- 用户隐私保护
- 数据安全存储
- 访问权限控制

### 2. 审计要求

**交易审计**：
- 完整的交易记录
- 可追溯的操作历史
- 合规性报告生成

**安全审计**：
- 定期安全评估
- 漏洞扫描和修复
- 代码审查流程

## 风险控制

### 1. 技术风险

**智能合约风险**：
- 代码审计和测试
- 多重签名保护
- 紧急暂停机制

**网络安全**：
- 访问控制
- 数据加密
- 监控告警

### 2. 业务风险

**市场风险**：
- 价格波动管理
- 流动性风险控制
- 市场异常处理

**操作风险**：
- 权限管理
- 操作流程规范
- 异常情况处理

## 总结

本RWA智能合约系统通过模块化设计和严格的合规机制，为房地产抵押贷款的代币化提供了安全、可靠的解决方案。系统支持完整的贷款生命周期管理，从创建到结清，同时确保所有操作都符合监管要求和安全标准。

通过KYC验证、权限控制、状态管理和事件系统，系统能够有效防止恶意操作，保护用户资产安全，并提供透明的操作记录。系统的设计充分考虑了可扩展性、可维护性和合规性，为未来的功能扩展和监管要求变化提供了良好的基础。
