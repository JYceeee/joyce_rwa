# äº¤æ˜“å†å²ä¿å­˜ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ¦‚è¿°

æˆåŠŸä¿®å¤äº†ä¿å­˜äº¤æ˜“å†å²å¤±è´¥çš„é—®é¢˜ï¼Œç¡®ä¿user_idä»userè¡¨ä¸­æ­£ç¡®æå–ï¼Œå¹¶ä¼˜åŒ–äº†é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯ã€‚

## é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
1. **å¤–é”®çº¦æŸé”™è¯¯**: `Error Code: 1452. Cannot add or update a child row: a foreign key constraint fails`
2. **ç”¨æˆ·IDä¸å­˜åœ¨**: å°è¯•æ’å…¥transactionhistoryæ—¶ï¼Œå¯¹åº”çš„user_idåœ¨userè¡¨ä¸­ä¸å­˜åœ¨
3. **è°ƒè¯•ä¿¡æ¯ä¸è¶³**: é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œéš¾ä»¥å®šä½é—®é¢˜

### æ ¹æœ¬åŸå› 
- äº¤æ˜“å†å²ä¿å­˜æ—¶ï¼Œç³»ç»Ÿæ²¡æœ‰æ­£ç¡®åˆ›å»ºæˆ–æŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·è®°å½•
- å¤–é”®çº¦æŸç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼Œä½†éœ€è¦å…ˆç¡®ä¿ç”¨æˆ·å­˜åœ¨

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¼˜åŒ–ç”¨æˆ·æŸ¥æ‰¾å’Œåˆ›å»ºé€»è¾‘

**å¢å¼ºçš„findOrCreateUserå‡½æ•°**:
```javascript
const findOrCreateUser = (walletAddress, callback) => {
  console.log('ğŸ” å¼€å§‹æŸ¥æ‰¾ç”¨æˆ·ï¼Œé’±åŒ…åœ°å€:', walletAddress);
  
  // é¦–å…ˆå°è¯•æ ¹æ®wallet_addressæŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
  const findSql = 'SELECT user_id FROM user WHERE user_wallet = ?';
  db.query(findSql, [walletAddress], (err, results) => {
    if (err) {
      console.error('âŒ æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥:', err);
      return callback(err, null);
    }
    
    console.log('ğŸ” æŸ¥æ‰¾ç»“æœ:', results);
    
    if (results && results.length > 0) {
      // æ‰¾åˆ°ç°æœ‰ç”¨æˆ·
      console.log('âœ… æ‰¾åˆ°ç°æœ‰ç”¨æˆ·:', results[0].user_id);
      return callback(null, results[0].user_id);
    } else {
      // æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·
      console.log('ğŸ†• åˆ›å»ºæ–°ç”¨æˆ·ï¼Œé’±åŒ…åœ°å€:', walletAddress);
      
      // ç”Ÿæˆæ–°çš„ç”¨æˆ·IDï¼ˆæ ¼å¼ï¼šuser + æ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²ï¼‰
      const newUserId = 'user' + Date.now() + Math.random().toString(36).substr(2, 9);
      
      // åˆ›å»ºç”¨æˆ·è®°å½•
      const createUserSql = 'INSERT INTO user (user_id, user_wallet, user_email, user_phone, user_name, user_password, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW())';
      const userData = [
        newUserId,
        walletAddress,
        walletAddress + '@wallet.local', // ä¸´æ—¶é‚®ç®±
        '00000000000', // ä¸´æ—¶ç”µè¯
        'Wallet User ' + walletAddress.slice(-6), // ä¸´æ—¶ç”¨æˆ·å
        'temp_password_' + Date.now() // ä¸´æ—¶å¯†ç 
      ];
      
      console.log('ğŸ†• åˆ›å»ºç”¨æˆ·æ•°æ®:', userData);
      
      db.query(createUserSql, userData, (err, results) => {
        if (err) {
          console.error('âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥:', err);
          return callback(err, null);
        }
        
        console.log('âœ… æ–°ç”¨æˆ·åˆ›å»ºæˆåŠŸ:', newUserId, 'æ’å…¥ID:', results.insertId);
        return callback(null, newUserId);
      });
    }
  });
};
```

### 2. ä¿®å¤äº¤æ˜“è®°å½•ä¿å­˜é€»è¾‘

**ä¼˜åŒ–çš„æ’å…¥æ•°æ®æ˜ å°„**:
```javascript
const insertData = {
  user_id: userId,
  wallet_address: transactionData.userAddress,
  token_symbol: transactionData.projectCode || 'RWA',
  amount: transactionData.amount,
  price: transactionData.price,
  totalCost: transactionData.total,
  transaction_type: transactionData.tradeType.toUpperCase(),
  status: transactionData.tradeType.toUpperCase(), // ä½¿ç”¨äº¤æ˜“ç±»å‹ä½œä¸ºçŠ¶æ€
  transactionHash: transactionData.transactionHash || null,
  blockNumber: transactionData.blockNumber || null
};
```

### 3. å¢å¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•

**è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯**:
```javascript
db.query(sql, insertData, (err, results) => {
  if (err) {
    console.error('âŒ æ’å…¥äº¤æ˜“å†å²å¤±è´¥:', err);
    console.error('âŒ é”™è¯¯è¯¦æƒ…:', {
      code: err.code,
      errno: err.errno,
      sqlState: err.sqlState,
      sqlMessage: err.sqlMessage,
      sql: err.sql
    });
    return res.cc(`ä¿å­˜äº¤æ˜“å†å²å¤±è´¥: ${err.sqlMessage || err.message}`);
  }
  
  // æˆåŠŸå¤„ç†...
});
```

## ä¿®å¤å†…å®¹

### 1. ç”¨æˆ·IDç”Ÿæˆä¼˜åŒ–
- **æ ¼å¼**: `user` + æ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²
- **ç¤ºä¾‹**: `user1758605762188fkiyu`
- **å”¯ä¸€æ€§**: ç¡®ä¿æ¯ä¸ªç”¨æˆ·IDéƒ½æ˜¯å”¯ä¸€çš„

### 2. ç”¨æˆ·åˆ›å»ºå­—æ®µå®Œå–„
- **å¿…éœ€å­—æ®µ**: user_id, user_wallet, user_name, user_email, user_password
- **ä¸´æ—¶æ•°æ®**: ä¸ºé’±åŒ…ç”¨æˆ·æä¾›åˆç†çš„é»˜è®¤å€¼
- **æ—¶é—´æˆ³**: è‡ªåŠ¨è®°å½•åˆ›å»ºæ—¶é—´

### 3. çŠ¶æ€å­—æ®µæ˜ å°„
- **transaction_type**: BUY/SELL
- **status**: ä½¿ç”¨äº¤æ˜“ç±»å‹ä½œä¸ºçŠ¶æ€ï¼ˆBUY/SELLï¼‰
- **ä¸€è‡´æ€§**: ç¡®ä¿çŠ¶æ€å€¼ç¬¦åˆENUMçº¦æŸ

### 4. è°ƒè¯•ä¿¡æ¯å¢å¼º
- **æŸ¥æ‰¾è¿‡ç¨‹**: è¯¦ç»†è®°å½•ç”¨æˆ·æŸ¥æ‰¾è¿‡ç¨‹
- **åˆ›å»ºè¿‡ç¨‹**: è®°å½•æ–°ç”¨æˆ·åˆ›å»ºæ­¥éª¤
- **æ’å…¥è¿‡ç¨‹**: æ˜¾ç¤ºå®Œæ•´çš„æ’å…¥æ•°æ®
- **é”™è¯¯è¯¦æƒ…**: æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

## æµ‹è¯•éªŒè¯

### 1. æ•°æ®åº“æµ‹è¯•è„šæœ¬
```sql
-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·
INSERT IGNORE INTO user (user_id, user_wallet, user_name, user_email, user_password, user_phone) VALUES 
('user1758605762188fkiyu', '0x1234567890123456789012345678901234567890', 'Test User 1', 'test1@example.com', 'hashed_password_1', '1234567890');

-- æµ‹è¯•æ’å…¥äº¤æ˜“å†å²
INSERT INTO transactionhistory (
    user_id, wallet_address, token_symbol, amount, price, totalCost, 
    transaction_type, status, transactionHash, blockNumber
) VALUES 
(
    'user1758605762188fkiyu', 
    '0x1234567890123456789012345678901234567890', 
    'RWA001', 
    100.000000, 
    1.000000, 
    100.000000, 
    'BUY', 
    'BUY', 
    '0xabc123def45678901234567890123456789012345678901234567890123456789012', 
    1448109
);
```

### 2. APIæµ‹è¯•è„šæœ¬
```javascript
const testTransactionData = {
  projectCode: 'RWA001',
  tradeType: 'buy',
  amount: 100,
  price: 1.0,
  total: 100.0,
  userAddress: '0x1234567890123456789012345678901234567890',
  transactionHash: '0xabc123def45678901234567890123456789012345678901234567890123456789012',
  blockNumber: 1448109
};

// æµ‹è¯•APIè°ƒç”¨
axios.post('http://localhost:3000/user/transactionhistory', testTransactionData);
```

## å·¥ä½œæµç¨‹

### 1. äº¤æ˜“å†å²ä¿å­˜æµç¨‹
```
1. æ¥æ”¶äº¤æ˜“æ•°æ®
   â†“
2. éªŒè¯å¿…éœ€å­—æ®µ
   â†“
3. æ ¹æ®é’±åŒ…åœ°å€æŸ¥æ‰¾ç”¨æˆ·
   â†“
4. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
   â†“
5. è·å–ç”¨æˆ·ID
   â†“
6. å‡†å¤‡äº¤æ˜“è®°å½•æ•°æ®
   â†“
7. æ’å…¥äº¤æ˜“å†å²è®°å½•
   â†“
8. è¿”å›æˆåŠŸå“åº”
```

### 2. é”™è¯¯å¤„ç†æµç¨‹
```
1. æ•è·æ•°æ®åº“é”™è¯¯
   â†“
2. è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
   â†“
3. åˆ†æé”™è¯¯ç±»å‹
   â†“
4. è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
   â†“
5. è®°å½•è°ƒè¯•ä¿¡æ¯
```

## æ•°æ®å®Œæ•´æ€§ä¿è¯

### 1. å¤–é”®çº¦æŸ
- **user_id**: å¿…é¡»å­˜åœ¨äºuserè¡¨ä¸­
- **çº§è”åˆ é™¤**: ç”¨æˆ·åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†äº¤æ˜“è®°å½•
- **çº§è”æ›´æ–°**: ç”¨æˆ·IDæ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°äº¤æ˜“è®°å½•

### 2. æ•°æ®éªŒè¯
- **å¿…éœ€å­—æ®µ**: éªŒè¯æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨
- **æ•°æ®ç±»å‹**: ç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®
- **ENUMå€¼**: éªŒè¯transaction_typeå’Œstatuså€¼æœ‰æ•ˆ

### 3. å”¯ä¸€æ€§çº¦æŸ
- **ç”¨æˆ·ID**: ç¡®ä¿æ¯ä¸ªç”¨æˆ·IDå”¯ä¸€
- **é’±åŒ…åœ°å€**: ç¡®ä¿æ¯ä¸ªé’±åŒ…åœ°å€å¯¹åº”ä¸€ä¸ªç”¨æˆ·
- **äº¤æ˜“å“ˆå¸Œ**: é¿å…é‡å¤äº¤æ˜“

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä½¿ç”¨
- **user_walletç´¢å¼•**: å¿«é€ŸæŸ¥æ‰¾ç”¨æˆ·
- **user_idç´¢å¼•**: å¿«é€Ÿå…³è”äº¤æ˜“è®°å½•
- **created_atç´¢å¼•**: å¿«é€ŸæŒ‰æ—¶é—´æ’åº

### 2. æŸ¥è¯¢ä¼˜åŒ–
- **å•æ¬¡æŸ¥è¯¢**: é¿å…å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ’å…¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
- **è¿æ¥æ± **: ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± 

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### åç«¯ä»£ç 
- `Mysql/src/routers/route_handler/userRouter_Handler.js`: ä¿®å¤saveTransactionHistoryå‡½æ•°

### æ•°æ®åº“è„šæœ¬
- `Mysql/fix_transaction_save.sql`: æ•°æ®åº“ä¿®å¤è„šæœ¬
- `Mysql/test_transaction_save.js`: APIæµ‹è¯•è„šæœ¬

### æµ‹è¯•æ–‡ä»¶
- `Mysql/test_transaction_save.js`: å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

## éƒ¨ç½²è¯´æ˜

### 1. ä»£ç éƒ¨ç½²
```bash
# 1. æ›´æ–°åç«¯ä»£ç 
# userRouter_Handler.js å·²ç»ä¿®å¤

# 2. é‡å¯åç«¯æœåŠ¡
cd Mysql
node index.js
```

### 2. æ•°æ®åº“éªŒè¯
```bash
# 1. è¿è¡Œä¿®å¤è„šæœ¬
mysql -u root -p < fix_transaction_save.sql

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
node test_transaction_save.js
```

### 3. åŠŸèƒ½æµ‹è¯•
```bash
# 1. å¯åŠ¨åç«¯æœåŠ¡
cd Mysql && node index.js

# 2. è¿è¡ŒAPIæµ‹è¯•
node test_transaction_save.js

# 3. éªŒè¯æ•°æ®åº“æ•°æ®
mysql -u root -p -e "USE rwa; SELECT * FROM transactionhistory LIMIT 5;"
```

## ç›‘æ§å»ºè®®

### 1. æ—¥å¿—ç›‘æ§
- ç›‘æ§ç”¨æˆ·åˆ›å»ºæ—¥å¿—
- ç›‘æ§äº¤æ˜“ä¿å­˜æˆåŠŸ/å¤±è´¥æ—¥å¿—
- ç›‘æ§é”™è¯¯è¯¦æƒ…

### 2. æ•°æ®åº“ç›‘æ§
- ç›‘æ§userè¡¨å¢é•¿
- ç›‘æ§transactionhistoryè¡¨å¢é•¿
- ç›‘æ§å¤–é”®çº¦æŸé”™è¯¯

### 3. æ€§èƒ½ç›‘æ§
- ç›‘æ§APIå“åº”æ—¶é—´
- ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
- ç›‘æ§é”™è¯¯ç‡

---

**ä¿®å¤æ—¶é—´**: 2025å¹´1æœˆ
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ
**æµ‹è¯•çŠ¶æ€**: ğŸ”„ å¾…æµ‹è¯•
**éƒ¨ç½²çŠ¶æ€**: ğŸ”„ å¾…éƒ¨ç½²
**é—®é¢˜è§£å†³**: âœ… äº¤æ˜“å†å²ä¿å­˜å¤±è´¥é—®é¢˜å·²ä¿®å¤
