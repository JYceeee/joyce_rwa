<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户API测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
        .user-data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        .field {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .field-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 4px;
        }
        .field-value {
            color: #212529;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 用户API测试工具</h1>
        
        <div class="test-section info">
            <h3>📋 测试说明</h3>
            <p>这个页面用于测试 <code>http://localhost:3000/user/login</code> API端点，验证Profile页面能否正确获取用户名、邮箱和手机号。</p>
        </div>

        <div class="test-section">
            <h3>1. 登录状态检查</h3>
            <p>检查当前登录状态和认证token：</p>
            <button class="btn" onclick="checkLoginStatus()">检查登录状态</button>
            <div id="loginStatusResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. API端点测试</h3>
            <p>测试用户API端点的可用性和数据格式：</p>
            <button class="btn" onclick="testUserAPI()">测试用户API</button>
            <button class="btn btn-warning" onclick="testWithDifferentMethods()">测试不同请求方法</button>
            <div id="apiTestResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. 用户数据显示</h3>
            <p>如果API测试成功，这里将显示用户数据：</p>
            <div id="userDataDisplay" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. Profile页面集成测试</h3>
            <p>测试Profile页面是否能正确使用API数据：</p>
            <button class="btn btn-success" onclick="testProfileIntegration()">测试Profile集成</button>
            <button class="btn" onclick="openProfilePage()">打开Profile页面</button>
            <div id="profileTestResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. 后端服务器状态</h3>
            <button class="btn" onclick="checkBackendStatus()">检查后端状态</button>
            <div id="backendStatus" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. 常见问题排查</h3>
            <div id="troubleshooting">
                <h4>可能的问题和解决方案：</h4>
                <ul>
                    <li><strong>API端点不存在</strong>: 确保后端服务器运行并配置了 /user 路由</li>
                    <li><strong>数据库连接失败</strong>: 检查MySQL数据库连接和用户表</li>
                    <li><strong>跨域问题</strong>: 确保后端允许前端域名的跨域请求</li>
                    <li><strong>用户数据不存在</strong>: 检查数据库中是否有用户数据</li>
                    <li><strong>网络连接问题</strong>: 确保前端能访问 localhost:3000</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>6. 快速修复建议</h3>
            <button class="btn btn-success" onclick="quickFix1()">修复1: 检查后端服务器</button>
            <button class="btn btn-success" onclick="quickFix2()">修复2: 检查API路由</button>
            <button class="btn btn-success" onclick="quickFix3()">修复3: 检查数据库</button>
            <div id="fixResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        const USER_API_ENDPOINT = '/user/login';
        
        function checkLoginStatus() {
            const resultDiv = document.getElementById('loginStatusResult');
            resultDiv.style.display = 'block';
            
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const token = localStorage.getItem('token');
            const rememberEmail = localStorage.getItem('remember_email');
            
            let status = '登录状态检查结果:\n\n';
            
            if (isLoggedIn === 'true') {
                status += '✅ 登录状态: 已登录\n';
            } else {
                status += '❌ 登录状态: 未登录\n';
            }
            
            if (token) {
                status += `✅ 认证Token: ${token.substring(0, 30)}...\n`;
                status += `Token长度: ${token.length} 字符\n`;
            } else {
                status += '❌ 认证Token: 不存在\n';
            }
            
            if (rememberEmail) {
                status += `✅ 记住的邮箱: ${rememberEmail}\n`;
            } else {
                status += '⚪ 记住的邮箱: 无\n';
            }
            
            status += '\n建议:';
            if (!isLoggedIn || !token) {
                status += '\n1. 需要先登录才能测试用户API';
                status += '\n2. 访问登录页面: /login';
                status += '\n3. 登录成功后再测试API';
            } else {
                status += '\n1. 登录状态正常，可以测试用户API';
                status += '\n2. 点击"测试用户API"按钮';
            }
            
            resultDiv.textContent = status;
            
            if (isLoggedIn === 'true' && token) {
                resultDiv.style.backgroundColor = '#d4edda';
            } else {
                resultDiv.style.backgroundColor = '#f8d7da';
            }
        }
        
        async function testUserAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            const userDataDiv = document.getElementById('userDataDisplay');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 正在测试用户API...';
            resultDiv.style.backgroundColor = '#fff3cd';
            
            try {
                console.log('🔍 测试API端点:', `${API_BASE}${USER_API_ENDPOINT}`);
                
                // 检查是否有登录token
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    console.log('🔑 使用认证token:', token.substring(0, 20) + '...');
                } else {
                    console.warn('⚠️ 没有找到认证token，可能需要先登录');
                }
                
                const response = await fetch(`${API_BASE}${USER_API_ENDPOINT}`, {
                    method: 'GET',
                    headers: headers,
                });
                
                console.log('📡 API响应:', response.status, response.statusText);
                
                if (response.ok) {
                    const userData = await response.json();
                    console.log('✅ 用户数据:', userData);
                    
                    resultDiv.innerHTML = `✅ API测试成功!
状态码: ${response.status}
响应时间: ${Date.now()}ms
数据大小: ${JSON.stringify(userData).length} 字符

用户数据:
${JSON.stringify(userData, null, 2)}`;
                    resultDiv.style.backgroundColor = '#d4edda';
                    
                    // 显示用户数据
                    displayUserData(userData);
                    
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `❌ API测试失败!
状态码: ${response.status}
错误信息: ${response.statusText}
响应内容: ${errorText}

建议:
1. 检查后端服务器是否运行
2. 检查API路由是否正确配置
3. 检查数据库连接`;
                    resultDiv.style.backgroundColor = '#f8d7da';
                }
                
            } catch (error) {
                console.error('❌ API测试失败:', error);
                resultDiv.innerHTML = `❌ 网络请求失败!
错误: ${error.message}

可能原因:
1. 后端服务器未运行 (localhost:3000)
2. 网络连接问题
3. 跨域请求被阻止
4. API端点不存在

建议:
1. 启动后端服务器: cd Mysql && npm start
2. 检查服务器是否在端口3000运行
3. 验证API路由配置`;
                resultDiv.style.backgroundColor = '#f8d7da';
            }
        }
        
        function displayUserData(userData) {
            const userDataDiv = document.getElementById('userDataDisplay');
            userDataDiv.style.display = 'block';
            
            let html = '<div class="user-data"><h4>📊 用户数据详情</h4>';
            
            const fields = [
                { key: 'name', label: '用户名', required: true },
                { key: 'email', label: '邮箱', required: true },
                { key: 'phone', label: '手机号', required: true },
                { key: 'firstName', label: '名', required: false },
                { key: 'lastName', label: '姓', required: false },
                { key: 'id', label: '用户ID', required: false },
                { key: 'createdAt', label: '创建时间', required: false }
            ];
            
            fields.forEach(field => {
                const value = userData[field.key];
                const status = value ? '✅' : (field.required ? '❌' : '⚪');
                const valueText = value || (field.required ? '缺少必需字段' : '无');
                
                html += `
                    <div class="field">
                        <div class="field-label">${status} ${field.label}:</div>
                        <div class="field-value">${valueText}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            userDataDiv.innerHTML = html;
        }
        
        async function testWithDifferentMethods() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 测试不同请求方法...';
            
            const methods = ['GET', 'POST', 'PUT', 'DELETE'];
            let results = [];
            
            for (const method of methods) {
                try {
                    const response = await fetch(`${API_BASE}/user`, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    results.push(`${method}: ${response.status} ${response.statusText}`);
                } catch (error) {
                    results.push(`${method}: ERROR - ${error.message}`);
                }
            }
            
            resultDiv.innerHTML = `不同请求方法测试结果:
${results.join('\n')}

说明:
- GET: 应该返回用户数据 (200 OK)
- POST/PUT/DELETE: 可能返回方法不允许 (405 Method Not Allowed)

Profile页面现在会显示:
✅ 用户名 (name)
✅ 邮箱 (email) 
✅ 手机号 (phone) - 新增显示`;
            resultDiv.style.backgroundColor = '#d1ecf1';
        }
        
        function testProfileIntegration() {
            const resultDiv = document.getElementById('profileTestResult');
            resultDiv.style.display = 'block';
            
            resultDiv.innerHTML = `Profile页面集成测试:

1. 检查ProfileView.vue是否正确导入API调用
2. 验证computed属性是否优先使用API数据
3. 测试用户信息显示是否正确
4. 检查错误处理和加载状态

测试步骤:
1. 打开Profile页面: http://localhost:5173/profile
2. 检查用户名是否从API获取
3. 查看浏览器控制台是否有错误
4. 测试刷新按钮功能

如果API数据正确，Profile页面应该显示:
- 用户名来自API
- 邮箱地址显示 (📧 Email: user@example.com)
- 手机号显示 (📱 Phone: +1234567890) - 新增
- 加载指示器正常工作
- 错误处理正确显示
- 联系信息区域美观显示`;
            
            resultDiv.style.backgroundColor = '#d1ecf1';
        }
        
        function openProfilePage() {
            const profileUrl = window.location.origin.replace('5173', '5173') + '/profile';
            window.open(profileUrl, '_blank');
        }
        
        async function checkBackendStatus() {
            const resultDiv = document.getElementById('backendStatus');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 检查后端服务器状态...';
            
            try {
                // 尝试多个端点来检查服务器状态
                const endpoints = [USER_API_ENDPOINT, '/api/project', '/'];
                let results = [];
                
            for (const endpoint of endpoints) {
                try {
                    const token = localStorage.getItem('token');
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, { 
                        method: 'HEAD',
                        headers: headers
                    });
                    results.push(`✅ ${endpoint}: ${response.status}`);
                } catch (error) {
                    results.push(`❌ ${endpoint}: ${error.message}`);
                }
            }
                
                resultDiv.innerHTML = `后端服务器状态检查:
${results.join('\n')}

服务器地址: ${API_BASE}
检查时间: ${new Date().toLocaleString()}`;
                
                if (results.some(r => r.includes('✅'))) {
                    resultDiv.style.backgroundColor = '#d4edda';
                } else {
                    resultDiv.style.backgroundColor = '#f8d7da';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `❌ 后端服务器检查失败!
错误: ${error.message}

建议:
1. 启动后端服务器: cd Mysql && npm start
2. 检查服务器是否在端口3000运行
3. 验证服务器配置`;
                resultDiv.style.backgroundColor = '#f8d7da';
            }
        }
        
        function quickFix1() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `修复1: 检查后端服务器

步骤:
1. 打开新的命令行窗口
2. 导航到 Mysql 目录: cd Mysql
3. 启动服务器: npm start
4. 等待看到 "Server running on port 3000" 消息
5. 返回此页面重新测试

或者使用PowerShell脚本:
cd Mysql
.\\start-backend.ps1`;
            resultDiv.style.backgroundColor = '#d1ecf1';
        }
        
        function quickFix2() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `修复2: 检查API路由

确保后端服务器有以下路由配置:
- GET /user - 返回用户信息
- 支持CORS跨域请求
- 返回JSON格式数据

示例路由代码:
app.get('/user', (req, res) => {
  res.json({
    name: 'John Doe',
    email: 'john@example.com',
    firstName: 'John',
    lastName: 'Doe'
  });
});`;
            resultDiv.style.backgroundColor = '#d1ecf1';
        }
        
        function quickFix3() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `修复3: 检查数据库

确保:
1. MySQL数据库正在运行
2. 数据库连接配置正确
3. 用户表存在且有数据

检查命令:
1. 连接到MySQL数据库
2. 查看用户表: SELECT * FROM users LIMIT 5;
3. 确保有用户数据存在

如果数据库为空，可以插入测试数据:
INSERT INTO users (name, email) VALUES ('Test User', 'test@example.com');`;
            resultDiv.style.backgroundColor = '#d1ecf1';
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            setTimeout(() => {
                checkLoginStatus();
                checkBackendStatus();
            }, 1000);
        };
    </script>
</body>
</html>
