<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeProjectView 数据映射测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }
        .data-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .data-panel {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .field-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .field-item:last-child {
            border-bottom: none;
        }
        .field-name {
            font-weight: bold;
            color: #333;
        }
        .field-value {
            color: #666;
            font-family: monospace;
        }
        .match { background-color: #d4edda; }
        .mismatch { background-color: #f8d7da; }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 TradeProjectView 数据映射更新测试</h1>
        
        <div class="test-section info">
            <h3>📋 更新概述</h3>
            <p><strong>目标:</strong> 按照ProjectsView页面的方式更新TradeProjectView中的项目信息卡片信息抓取</p>
            <p><strong>主要改进:</strong></p>
            <ul>
                <li>✅ 统一数据映射逻辑，与ProjectsView保持一致</li>
                <li>✅ 改进字段映射，支持多种数据源</li>
                <li>✅ 优化metrics对象创建</li>
                <li>✅ 增强错误处理和调试日志</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🔄 数据映射对比</h3>
            <div class="data-comparison">
                <div class="data-panel">
                    <h4>更新前 (原始API数据)</h4>
                    <div class="field-item">
                        <span class="field-name">code</span>
                        <span class="field-value">rawData.code</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">name</span>
                        <span class="field-value">rawData.name</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">targetYield</span>
                        <span class="field-value">rawData.target_yield</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">loanAmount</span>
                        <span class="field-value">rawData.loan_amount</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">loanTerm</span>
                        <span class="field-value">rawData.loan_term</span>
                    </div>
                </div>
                
                <div class="data-panel">
                    <h4>更新后 (映射后的数据)</h4>
                    <div class="field-item match">
                        <span class="field-name">code</span>
                        <span class="field-value">rawData.code</span>
                    </div>
                    <div class="field-item match">
                        <span class="field-name">name</span>
                        <span class="field-value">rawData.name</span>
                    </div>
                    <div class="field-item match">
                        <span class="field-name">targetYield</span>
                        <span class="field-value">rawData.interestRate</span>
                    </div>
                    <div class="field-item match">
                        <span class="field-name">loanAmount</span>
                        <span class="field-value">AUD$format(rawData.loanAmount)</span>
                    </div>
                    <div class="field-item match">
                        <span class="field-name">loanTerm</span>
                        <span class="field-value">rawData.loanTermMonths + " months"</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 新增字段映射</h3>
            <div class="code-block">
// 认购信息
totalOffering: rawData.total_offering_token ? `AUD$${rawData.total_offering_token.toLocaleString()}` : 'AUD$0',
subscribed: rawData.subscribe_token ? `AUD$${rawData.subscribe_token.toLocaleString()}` : 'AUD$0',

// 原始数值用于计算
totalOfferingRaw: rawData.total_offering_token || 0,
subscribedRaw: rawData.subscribe_token || 0,

// 物业信息
propertyLocation: rawData.propertyLocation,
propertyState: rawData.propertyState,
propertyType: rawData.propertyType,
propertyValue: rawData.propertyValue,

// 贷款信息
loanType: rawData.loanType,
loanProduct: rawData.loanProduct,
loanAmount: rawData.loanAmount ? `AUD$${rawData.loanAmount.toLocaleString()}` : 'AUD$0',
loanTermMonths: rawData.loanTermMonths,
loanTerm: `${rawData.loanTermMonths || 12} months`,

// 收益率信息
targetYield: rawData.interestRate,
interestRate: rawData.interestRate,
            </div>
        </div>

        <div class="test-section">
            <h3>🎯 Metrics对象创建</h3>
            <div class="code-block">
// 创建metrics对象（与ProjectsView保持一致）
metrics: {
  currentElaraPrice: this.calculateTokenPrice(rawData),
  collateralPropertyValue: rawData.propertyValue || 'TBA',
  rentalIncome: this.calculateRentalIncome(rawData),
  targetLoanYield: `${rawData.interestRate || 6.0}% p.a.`
}
            </div>
        </div>

        <div class="test-section">
            <h3>🔍 改进的获取方法</h3>
            <div class="code-block">
// 获取项目目标收益率 - 支持多种数据源
getProjectTargetYield() {
  // 优先从 targetYield 字段获取
  if (this.projectData.targetYield) {
    return parseFloat(this.projectData.targetYield)
  }
  
  // 从 interestRate 字段获取
  if (this.projectData.interestRate) {
    return parseFloat(this.projectData.interestRate)
  }
  
  // 从 metrics.targetLoanYield 解析
  if (this.projectData.metrics?.targetLoanYield) {
    const match = this.projectData.metrics.targetLoanYield.match(/(\d+\.?\d*)/)
    return match ? parseFloat(match[1]) : null
  }
  
  return null
}

// 获取项目贷款期限 - 支持月数和天数转换
getProjectLoanTerm() {
  // 优先从 loanTermMonths 字段获取（月数）
  if (this.projectData.loanTermMonths) {
    return this.projectData.loanTermMonths * 30.44 // 转换为天数
  }
  
  // 从 loanTerm 字段获取（天数）
  if (this.projectData.loanTerm) {
    return parseFloat(this.projectData.loanTerm)
  }
  
  return null
}
            </div>
        </div>

        <div class="test-section success">
            <h3>✅ 修复的问题</h3>
            <ul>
                <li><strong>数据一致性:</strong> 与ProjectsView使用相同的数据映射逻辑</li>
                <li><strong>字段映射:</strong> 正确映射API字段到前端显示字段</li>
                <li><strong>计算逻辑:</strong> 统一代币价格和租金收入计算</li>
                <li><strong>错误处理:</strong> 增强调试日志和错误提示</li>
                <li><strong>数据验证:</strong> 支持多种数据源和格式</li>
            </ul>
        </div>

        <div class="test-section warning">
            <h3>🚀 测试步骤</h3>
            <ol>
                <li>访问TradeProjectView页面（如：<code>/trade/RWA001</code>）</li>
                <li>检查项目信息卡片是否正确显示</li>
                <li>验证metrics数据是否正确计算</li>
                <li>测试认购摘要中的收益率和期限显示</li>
                <li>查看浏览器控制台的调试日志</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🔗 测试链接</h3>
            <p>点击以下链接测试更新后的TradeProjectView：</p>
            <a href="/trade/RWA001" class="btn btn-success" target="_blank">测试 RWA001</a>
            <a href="/trade/RWA007" class="btn btn-success" target="_blank">测试 RWA007</a>
            <a href="/trade/TEST" class="btn btn-success" target="_blank">测试 TEST</a>
        </div>

        <div class="test-section info">
            <h3>📝 调试信息</h3>
            <p>在浏览器开发者工具的控制台中，您应该能看到以下调试信息：</p>
            <ul>
                <li><code>🔄 TradeProjectView: 从数据库加载项目数据...</code></li>
                <li><code>✅ TradeProjectView: 项目数据映射成功:</code></li>
                <li><code>获取目标收益率，projectData:</code></li>
                <li><code>获取贷款期限，projectData:</code></li>
                <li><code>🔍 TradeProjectView: 金额输入验证结果:</code></li>
            </ul>
        </div>
    </div>
</body>
</html>
